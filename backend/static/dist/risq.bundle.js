"use strict";(self.webpackChunkgray_online=self.webpackChunkgray_online||[]).push([[700],{3217:(t,e,i)=>{i.d(e,{Z:()=>n});var s=i(8081),o=i.n(s),r=i(3645),a=i.n(r)()(o());a.push([t.id,"dwg-risq #board{height:100%;overflow:hidden;width:100%}",""]);const n=a},2506:(t,e,i)=>{i.d(e,{Z:()=>n});var s=i(8081),o=i.n(s),r=i(3645),a=i.n(r)()(o());a.push([t.id,"dwg-space-dialog #wrapper{align-items:center;display:flex;flex-flow:column nowrap;height:var(--h);gap:1em;padding:0 !important;width:var(--w)}dwg-space-dialog #wrapper>#close-button{--size: 36px;right:0;margin:0;padding:4px;position:absolute;top:calc(-1*var(--size))}",""]);const n=a},5254:(t,e,i)=>{i.d(e,{Z:()=>n});var s=i(8081),o=i.n(s),r=i(3645),a=i.n(r)()(o());a.push([t.id,"dwg-canvas-board{background-color:#000;border:1px solid #fff;box-sizing:border-box;cursor:none;display:block;overflow:hidden}dwg-canvas-board #canvas{--h: 0px;--w: 0px;height:var(--h);position:relative;width:var(--w)}dwg-canvas-board #cursor{--x: -120px;--y: -120px;left:var(--x);position:absolute;top:var(--y);user-select:none;z-index:2}dwg-canvas-board #cursor.hide{display:none}",""]);const n=a},4431:(t,e,i)=>{var s=i(4268);function o(t,e,i,s=Math.PI/6){!function(t,e,i,s,o=0){e<3&&console.error("n must be 3+");const r=2*Math.PI/e;t.beginPath();for(var a=0;a<e;a++)t.lineTo(i.x+s*Math.cos(r*a+o),i.y+s*Math.sin(r*a+o));t.closePath(),t.stroke(),t.fill()}(t,6,e,i,s)}function r(t,e,i){t.beginPath(),t.ellipse(e.x,e.y,i.x,i.y,0,0,2*Math.PI),t.closePath(),t.stroke(),t.fill()}function a(t,e,i,s,o=0){t.beginPath(),t.roundRect(e.x,e.y,i,s,o),t.closePath(),t.stroke(),t.fill()}function n(t,e,i){t.beginPath(),t.lineTo(e.x,e.y),t.lineTo(i.x,i.y),t.stroke()}function h(t,e,i){var s,o,r;t.beginPath(),t.font&&(t.font=i.font),t.textAlign=null!==(s=i.align)&&void 0!==s?s:"left",t.textBaseline=null!==(o=i.baseline)&&void 0!==o?o:"top",t.direction=null!==(r=i.direction)&&void 0!==r?r:"ltr",i.fill_style&&(t.fillStyle=i.fill_style,t.fillText(e,i.p.x,i.p.y,i.w)),i.stroke_style&&(t.strokeStyle=i.stroke_style,t.lineWidth=i.stroke_width,t.strokeText(e,i.p.x,i.p.y,i.w))}function c(t,e){return!t&&!e||!(!t||!e)&&t.x===e.x&&t.y===e.y}function l(t,e){return{x:t.x+e.x,y:t.y+e.y}}function d(t,e){return{x:t.x-e.x,y:t.y-e.y}}function _(t,e){return{x:t*e.x,y:t*e.y}}function u(t,e){return{x:t.x*Math.cos(e)-t.y*Math.sin(e),y:t.x*Math.sin(e)+t.y*Math.cos(e)}}function g(t){let e=Math.round(t.x),i=Math.round(t.y),s=Math.round(-t.x-t.y);const o=Math.abs(e-t.x),r=Math.abs(i-t.y),a=Math.abs(s+t.x+t.y);return o>r&&o>a?e=-i-s:r>a?i=-e-s:s=-e-i,{x:e,y:i}}const y=[{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1}];function v(t,e){const i=.866*e,s=Math.abs(t.x),o=Math.abs(t.y);return!(s>i||o>e)&&e*i-.5*e*s-i*o>=0}function f(t,e){return!(Math.abs(t.x)>e||Math.abs(t.y)>e||Math.abs(t.x+t.y)>e)}var x=i(7483),p=i(6442);class m{constructor(t,e,i,s){this.data={r:0,g:0,b:0,a:0},this.setColor(t,e,i,s)}setColor(t,e,i,s){this.data=this.cleanInput(t,e,i,s)}getString(){return`rgb(${this.data.r}, ${this.data.g}, ${this.data.b}, ${this.data.a})`}addColor(t,e,i,s){const o=this.cleanInput(t,e,i,s),r=this.data.a+o.a;if(0===r)return void(this.data.a=0);const a=(this.data.a*this.data.r+o.a*o.r)/r,n=(this.data.a*this.data.g+o.a*o.g)/r,h=(this.data.a*this.data.b+o.a*o.b)/r;return this.data=this.cleanInput(a,n,h,r),this}dAlpha(t){return this.data.a+=t,this.cleanData(),this}getBrightness(){return(this.data.r+this.data.g+this.data.b)/765}cleanInput(t,e,i,s){return{r:t=(0,p.IV)(t,0,255),g:e=(0,p.IV)(e,0,255),b:i=(0,p.IV)(i,0,255),a:s=(0,p.IV)(s,0,1,!1)}}cleanData(){this.data=this.cleanInput(this.data.r,this.data.g,this.data.b,this.data.a)}}function w(t){let e="error";if(t)switch(t.resource_id){case 1:e="forage_bush";break;case 2:e="deer";break;case 11:e="tree_cedar";break;case 12:e="tree_dead";break;case 13:e="tree_maple";break;case 14:e="tree_oak";break;case 15:e="tree_pine";break;case 16:e="tree_walnut";break;case 21:e="stonemine";break;case 31:e="goldmine";break;default:return console.error("Trying to get resource image from unknown resource id",t.resource_id),""}return`risq/resources/${e}`}function b(t){return t.resource_id<11?L.FOOD:t.resource_id<21?L.WOOD:t.resource_id<31?L.STONE:t.resource_id<41?L.GOLD:L.ERROR}function I(t){let e="error";switch("number"==typeof t?t:b(t)){case L.FOOD:e="food";break;case L.WOOD:e="wood";break;case L.STONE:e="stone";break;case L.GOLD:e="gold"}return`risq/resources/${e}`}function k(t){let e="empty_plot";if(t)switch(t.building_id){case 1:e="village_center";break;case 2:e="housing";break;default:return console.error("Trying to get building image from unknown building id",t.building_id),""}return`risq/buildings/${e}`}const S="black",z="rgb(100, 250, 100)";function M(t){let e="";switch(t.unit_id){case 1:e="villager";break;case 11:e="swordsman";break;case 12:e="villager_aoe";break;default:return console.error("Trying to get unit image from unknown unit id",t.unit_id),""}return`risq/units/${e}`}function E(t,e=!0,i=1){const s=new m(10,120,10,.8);return e&&t.hovered&&!t.hovered_data.some((t=>t.hovered))&&(t.clicked?s.addColor(210,210,210,.06*i):s.addColor(190,190,190,.03*i)),s}function P(t,e,i,s,o,a,n,h,c){const l=s?"rgb(0, 0, 0)":"rgb(255, 255, 255)",d=s?"rgba(40, 40, 40, 0.4)":"rgba(210, 210, 210, 0.4)",_=s?"rgb(60, 60, 60, 0.2)":"rgba(190, 190, 190, 0.2)";function u(t,e,i,s,o,r,a=!0){const n=t.fillStyle;t.fillStyle=a?l:d,t.font=`bold ${i}px serif`,t.fillText(e,s,o,r),t.fillStyle=n}t.textAlign="left",t.textBaseline="top";const g=.5*o;if(3!==i.hovered_data.length||i.reset_hovered_data){const t={x:.5*g,y:.5*g};i.hovered_data=[{c:n,r:t},{c:h,r:t},{c,r:t}],i.reset_hovered_data=!1}else i.hovered_data[0].c=n,i.hovered_data[1].c=h,i.hovered_data[2].c=c;for(const[s,o]of i.hovered_data.entries()){switch(t.strokeStyle="transparent",o.hovered?o.clicked?t.fillStyle=d:t.fillStyle=_:t.fillStyle="transparent",t.translate(o.c.x,o.c.y),t.rotate(-a),s){case 0:i.resource?t.drawImage(e.getIcon(w(i.resource)),-o.r.x,-o.r.y,2*o.r.x,2*o.r.y):t.drawImage(e.getIcon(k(i.building)),-o.r.x,-o.r.y,2*o.r.x,2*o.r.y);break;case 1:case 2:const r=1===s?i.economic_units_by_type:i.military_units_by_type;if(0===r.size){t.strokeStyle=d;break}if(r.size>1)break;const a=[...r.values()][0];if(0===a.length)t.strokeStyle=d;else if(1===a.length){const s=i.units.get([...a[0].units.values()][0]);t.drawImage(e.getIcon(M(s)),-o.r.x,-o.r.y,2*o.r.x,2*o.r.y),u(t,a[0].units.size.toString(),1.4*o.r.y,-o.r.x,-.7*o.r.y,2*o.r.x)}else if(2===a.length)for(let s=0;s<2;s++){const r=[...a[s].units.values()],n=i.units.get(r[0]);t.drawImage(e.getIcon(M(n)),(.5*s-1)*o.r.x,(.5*s-1)*o.r.y,1.5*o.r.x,1.5*o.r.y),u(t,r.length.toString(),o.r.y,(.5*s-1)*o.r.x,(.5*s-1)*o.r.y,2*o.r.x)}else if(3===a.length){for(let s=0;s<2;s++){const r=[...a[s].units.values()],n=i.units.get(r[0]);t.drawImage(e.getIcon(M(n)),(.8*s-.9)*o.r.x,-.9*o.r.y,o.r.x,o.r.y),u(t,r.length.toString(),.75*o.r.y,(.8*s-1)*o.r.x,-.9*o.r.y,1.5*o.r.x)}const s=[...a[2].units.values()],r=i.units.get(s[0]);t.drawImage(e.getIcon(M(r)),-.5*o.r.x,-.1*o.r.y,o.r.x,o.r.y),u(t,s.length.toString(),.75*o.r.y,-.5*o.r.x,-.1*o.r.y,1.5*o.r.x)}else if(4===a.length){for(let s=0;s<2;s++){const r=[...a[s].units.values()],n=i.units.get(r[0]);t.drawImage(e.getIcon(M(n)),(.8*s-.9)*o.r.x,-.9*o.r.y,o.r.x,o.r.y),u(t,r.length.toString(),.75*o.r.y,(.8*s-.9)*o.r.x,-.9*o.r.y,1.5*o.r.x)}for(let s=0;s<2;s++){const r=[...a[2+s].units.values()],n=i.units.get(r[0]);t.drawImage(e.getIcon(M(n)),(.8*s-.9)*o.r.x,-.1*o.r.y,o.r.x,o.r.y),u(t,r.length.toString(),.75*o.r.y,(.8*s-.9)*o.r.x,-.1*o.r.y,1.5*o.r.x)}}else{for(let s=0;s<2;s++){const r=[...a[s].units.values()],n=i.units.get(r[0]);t.drawImage(e.getIcon(M(n)),(.8*s-.9)*o.r.x,-.9*o.r.y,o.r.x,o.r.y)}for(let s=0;s<1;s++){const r=[...a[2+s].units.values()],n=i.units.get(r[0]);t.drawImage(e.getIcon(M(n)),(.8*s-.9)*o.r.x,-.1*o.r.y,o.r.x,o.r.y)}u(t,"...",.8*o.r.y,.1*o.r.x,-.1*o.r.y,o.r.x,!1),u(t,i.units.size.toString(),1.4*o.r.y,-o.r.x,-.7*o.r.y,2*o.r.x)}break;default:console.error("No implemented")}t.rotate(a),t.translate(-o.c.x,-o.c.y),r(t,o.c,o.r)}}function N(t,e,i,s,o){if(!e.zones)return;const r=(t,e,i)=>{if(e.hovered=!0,o)return;const s=u(t,i);for(const t of e.hovered_data){const e=s.x-t.c.x,i=s.y-t.c.y;e*e/(t.r.x*t.r.x)+i*i/(t.r.y*t.r.y)<=1?t.hovered=!0:t.hovered=!1}},a=d({x:t.x,y:t.y},null!=s?s:e.center);let n;if(v(a,.4*i))n=e.zones[1][1],r(a,n,0);else if(v(a,i)){const t=(0,p.fd)(a.y,a.x);let i=Math.floor((t+Math.PI/6)/(Math.PI/3)),s={x:0,y:0};switch(i){case 6:i=0;case 0:s={x:1,y:2};break;case 1:s={x:0,y:1};break;case 2:s={x:0,y:0};break;case 3:s={x:1,y:0};break;case 4:s={x:2,y:0};break;case 5:s={x:2,y:1};break;default:return void console.error("Unknown zone hovered",t)}n=e.zones[s.x][s.y],r(a,n,-Math.PI/3*(6-i))}return n}function T(t){if(t){t.clicked=!1,t.hovered=!1;for(const e of t.hovered_data)e.clicked=!1,e.hovered=!1}}var L,O,U,C,R;function A(t){return(0,x.kC)(O[t].replace("_"," ").toLowerCase())}function D(t){if(!t)return;const e={terrain:t.terrain,coordinate:t.coordinate,visibility:t.visibility,num_military_units:0,num_villager_units:0,center:{x:0,y:0},hovered:!1,hovered_neighbor:!1,hovered_row:!1,clicked:!1};if(t.zones){const i=[];for(const e of t.zones){const t=[];for(const i of e)t.push(B(i));i.push(t)}e.zones=i}if(t.resources){e.resources=new Map(t.resources.map((t=>[t.internal_id,Z(t)]))),e.total_resources=new Map;for(const t of e.resources.values()){const i=b(t);e.total_resources.has(i)?e.total_resources.set(i,e.total_resources.get(i)+t.resources_left):e.total_resources.set(i,t.resources_left)}}return t.buildings&&(e.buildings=new Map(t.buildings.map((t=>[t.internal_id,H(t)])))),t.units&&(e.units=new Map(t.units.map((t=>[t.internal_id,q(t)]))),e.num_military_units=[...e.units.values()].filter((t=>t.unit_id>10)).length,e.num_villager_units=[...e.units.values()].filter((t=>t.unit_id<11)).length),e}function B(t){if(!t)return;const e=new Map(t.units.map((t=>[t.internal_id,q(t)]))),i=function(t){const e=new Map;for(const i of t.values())e.has(i.player_id)||e.set(i.player_id,new Map),e.get(i.player_id).has(i.unit_id)?e.get(i.player_id).get(i.unit_id).units.add(i.internal_id):e.get(i.player_id).set(i.unit_id,{unit_id:i.unit_id,player_id:i.player_id,units:new Set([i.internal_id])});return e}(e),s=new Map,o=new Map;for(const[t,e]of i.entries()){s.set(t,[]),o.set(t,[]);for(const[i,r]of e.entries())i<11?s.get(t).push(r):o.get(t).push(r);0===s.get(t).length&&s.delete(t),0===o.get(t).length&&o.delete(t)}return{coordinate:t.coordinate,resource:Z(t.resource),building:H(t.building),units:e,hovered:!1,clicked:!1,hovered_data:[],units_by_type:i,economic_units_by_type:s,military_units_by_type:o,military_units:[...e.values()].filter((t=>t.unit_id>10)).sort(((t,e)=>t.unit_id-e.unit_id)).map((t=>t.internal_id)),economic_units:[...e.values()].filter((t=>t.unit_id<11)).sort(((t,e)=>t.unit_id-e.unit_id)).map((t=>t.internal_id))}}function H(t){if(t)return t.hover_data={ps:{x:0,y:0},pe:{x:0,y:0}},t}function Z(t){if(t)return t.hover_data={ps:{x:0,y:0},pe:{x:0,y:0}},t}function q(t){if(t)return t.hover_data={ps:{x:0,y:0},pe:{x:0,y:0}},t}function W(t,e){if(e.x<0||e.x>=t.spaces.length)return;const i=t.spaces[e.x];if(i){if(!(e.y<0||e.y>=i.length))return i[e.y]}else console.log(t.spaces,e.x)}function $(t,e){return{x:e.y+t,y:e.x-Math.max(-t,-(t+e.y))}}function G(t,e){const i=e.x-t;return{x:e.y+Math.max(-t,-(t+i)),y:i}}function Y(t,e,i,s,o,r){var a,n,h,c,l,d,_,u,g,y,v,f;o?s?(t.fillStyle=null!==(a=i.click_fill_style)&&void 0!==a?a:null!==(n=i.hover_fill_style)&&void 0!==n?n:i.fill_style,t.strokeStyle=null!==(h=i.click_stroke_style)&&void 0!==h?h:null!==(c=i.hover_stroke_style)&&void 0!==c?c:i.stroke_style,t.lineWidth=null!==(l=i.click_stroke_width)&&void 0!==l?l:null!==(d=i.hover_stroke_width)&&void 0!==d?d:i.stroke_width):i.draw_clicked_when_unhovered?(t.fillStyle=null!==(_=i.click_fill_style)&&void 0!==_?_:i.fill_style,t.strokeStyle=null!==(u=i.click_stroke_style)&&void 0!==u?u:i.stroke_style,t.lineWidth=null!==(g=i.click_stroke_width)&&void 0!==g?g:i.stroke_width):(t.fillStyle=i.fill_style,t.strokeStyle=i.stroke_style,t.lineWidth=i.stroke_width):s?(t.fillStyle=null!==(y=i.hover_fill_style)&&void 0!==y?y:i.fill_style,t.strokeStyle=null!==(v=i.hover_stroke_style)&&void 0!==v?v:i.stroke_style,t.lineWidth=null!==(f=i.hover_stroke_width)&&void 0!==f?f:i.stroke_width):(t.fillStyle=i.fill_style,t.strokeStyle=i.stroke_style,t.lineWidth=i.stroke_width),i.fixed_position&&(t.scale(1/e.scale,1/e.scale),t.translate(e.view.x,e.view.y)),t.beginPath(),r(),i.fixed_position&&(t.translate(-e.view.x,-e.view.y),t.scale(e.scale,e.scale))}function j(t){switch(t.button){case 0:return C.LEFT_MOUSE;case 1:return C.MIDDLE_MOUSE;case 2:return C.RIGHT_MOUSE;default:return C.UNKNOWN}}!function(t){t[t.ERROR=0]="ERROR",t[t.FOOD=1]="FOOD",t[t.WOOD=2]="WOOD",t[t.STONE=3]="STONE",t[t.GOLD=4]="GOLD"}(L||(L={})),function(t){t[t.FLATLANDS=0]="FLATLANDS",t[t.HILLY=1]="HILLY",t[t.MOUNTAINOUS=2]="MOUNTAINOUS",t[t.VALLEY=3]="VALLEY",t[t.SWAMP=4]="SWAMP",t[t.SHALLOWS=5]="SHALLOWS",t[t.WATER=6]="WATER",t[t.DEEP_WATER=7]="DEEP_WATER"}(O||(O={})),function(t){t[t.NONE=0]="NONE",t[t.BLUNT=1]="BLUNT",t[t.PIERCING=2]="PIERCING",t[t.MAGIC=3]="MAGIC",t[t.BLUNT_PIERCING=4]="BLUNT_PIERCING",t[t.PIERCING_MAGIC=5]="PIERCING_MAGIC",t[t.MAGIC_BLUNT=6]="MAGIC_BLUNT",t[t.BLUNT_PIERCING_MAGIC=7]="BLUNT_PIERCING_MAGIC"}(U||(U={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.LEFT_MOUSE=1]="LEFT_MOUSE",t[t.RIGHT_MOUSE=2]="RIGHT_MOUSE",t[t.MIDDLE_MOUSE=3]="MIDDLE_MOUSE",t[t.ENTER_KEY=4]="ENTER_KEY",t[t.HOLD_CLICK=5]="HOLD_CLICK"}(C||(C={}));class F{constructor(t){this.hovering=!1,this.clicking=!1,this.click_hold_timer=0,this.hold_clicks=0,t.hold_click&&(t.hold_click_time<1?(t.hold_click=!1,console.error("Must set hold click time for hold click buttons")):t.hold_click_delay<1&&(t.hold_click_delay=t.hold_click_time)),this.config=t}isHovering(){return this.hovering}setHovering(t){this.hovering=t}isClicking(){return this.clicking}setClicking(t){this.clicking=t}draw(t,e,i){this.clicking&&this.config.hold_click&&(this.click_hold_timer-=i,this.click_hold_timer<0&&(this.click_hold_timer+=this.config.hold_click_time,this.hold_clicks++,this.clicked(C.HOLD_CLICK))),this._draw(t,e,i)}mousemove(t,e){const i=this.hovering;return this.hovering=this.mouseOver(t,e),!i&&this.hovering?this.hovered():i&&!this.hovering&&this.unhovered(),this.hovering}mousedown(t){const e=j(t);return!(e===C.UNKNOWN||this.config.only_left_click&&e!==C.LEFT_MOUSE||!this.hovering||this.clicking||(this.clicking=!0,this.click_hold_timer=this.config.hold_click_delay,this.hold_clicks=0,this.clicked(e),0))}mouseup(t){const e=j(t);e!==C.UNKNOWN&&this.clicking&&(this.clicking=!1,this.released(e))}}class V extends F{constructor(t){var e,i,s;super(t.button_config),this.reached_target={x:!1,y:!1},t.move_animation_speed=null!==(e=t.move_animation_speed)&&void 0!==e?e:0,t.rotate_animation_speed=null!==(i=t.rotate_animation_speed)&&void 0!==i?i:0,t.image_path&&(this.img=document.createElement("img"),this.img.src=`/images/${t.image_path}.png`,this.img.draggable=!1),t.rotation=null!==(s=t.rotation)&&void 0!==s?s:0,this.rect_config=t,this.refreshPositionDependencies()}setPosition(t,e,i=!1){this.rect_config.move_animation_speed>0&&!c(t,this.rect_config.p)&&!i?(this.target_p=t,this.speed_p={x:(t.x-this.rect_config.p.x)/this.rect_config.move_animation_speed,y:(t.y-this.rect_config.p.y)/this.rect_config.move_animation_speed},this.reached_target={x:!1,y:!1},this.target_callback=e):(this.rect_config.p=t,this.refreshPositionDependencies(),e&&e())}setRotation(t,e,i=!1){if(this.rect_config.rotate_animation_speed>0&&t.angle!==this.rect_config.rotation&&!i){this.rotate_target=t;const i=(t.angle-this.rect_config.rotation)%(2*Math.PI);this.rotate_speed=i/this.rect_config.rotate_animation_speed,this.rotate_reached=!1,this.rotate_callback=e}else this.rect_config.rotation=t.angle,e&&e()}refreshPositionDependencies(){this.radius_p={x:.5*this.rect_config.w,y:.5*this.rect_config.h},this.center_p=l(this.rect_config.p,this.radius_p)}xi(){return this.rect_config.p.x}yi(){return this.rect_config.p.y}xf(){return this.rect_config.p.x+this.rect_config.w}yf(){return this.rect_config.p.y+this.rect_config.h}xc(){return this.center_p.x}yc(){return this.center_p.y}w(){return this.rect_config.w}h(){return this.rect_config.h}_draw(t,e,i){if(this.target_p&&this.speed_p){if(this.reached_target.x&&this.reached_target.y)this.rect_config.p=Object.assign({},this.target_p),this.target_p=void 0,this.speed_p=void 0,this.target_callback&&this.target_callback();else{if(!this.reached_target.x){const t=this.speed_p.x*i;Math.abs(this.rect_config.p.x-this.target_p.x)<=Math.abs(t)?(this.reached_target.x=!0,this.rect_config.p.x=this.target_p.x):(this.rect_config.p.x+=t,Math.abs(this.rect_config.p.x-this.target_p.x)<=Math.abs(t)&&(this.reached_target.x=!0))}if(!this.reached_target.y){const t=this.speed_p.y*i;Math.abs(this.rect_config.p.y-this.target_p.y)<=Math.abs(t)?(this.reached_target.y=!0,this.rect_config.p.y=this.target_p.y):(this.rect_config.p.y+=t,Math.abs(this.rect_config.p.y-this.target_p.y)<=Math.abs(t)&&(this.reached_target.y=!0))}}this.refreshPositionDependencies()}if(this.rotate_target&&this.rotate_speed){const t=this.rotate_speed*i;this.rotate_reached||Math.abs(this.rect_config.rotation-this.rotate_target.angle)<=Math.abs(t)?(this.rect_config.rotation=this.rotate_target.angle,this.rotate_target=void 0,this.rotate_speed=void 0,this.rotate_callback&&this.rotate_callback()):(this.rect_config.rotation+=t,Math.abs(this.rect_config.rotation-this.rotate_target.angle)<=Math.abs(t)&&(this.rotate_reached=!0))}Y(t,e,this.rect_config.draw_config,this.isHovering(),this.isClicking(),(()=>{t.beginPath(),t.translate(this.center_p.x,this.center_p.y),t.rotate(this.rect_config.rotation),this.img&&t.drawImage(this.img,-this.radius_p.x,-this.radius_p.y,this.rect_config.w,this.rect_config.h),a(t,_(-1,this.radius_p),this.rect_config.w,this.rect_config.h),t.rotate(-this.rect_config.rotation),t.translate(-this.center_p.x,-this.center_p.y)}))}mouseOver(t,e){return this.rect_config.draw_config.fixed_position&&(t={x:t.x*e.scale-e.view.x,y:t.y*e.scale-e.view.y}),!(t.x<this.xi()||t.y<this.yi()||t.x>this.xf()||t.y>this.yf())}}class K extends V{constructor(t){super(Object.assign(Object.assign({},t),{w:t.s,h:t.s}))}}class X extends K{constructor(t){super({button_config:{only_left_click:!0},p:{x:0,y:0},s:36,draw_config:{fill_style:"transparent",stroke_style:"transparent",stroke_width:0,hover_fill_style:"rgb(180, 180, 180, 0.5)",click_fill_style:"rgb(210, 210, 210, 0.7)",fixed_position:!0},move_animation_speed:200,rotate_animation_speed:400,image_path:"icons/triangle_gray36",rotation:-.5*Math.PI}),this.risq=t}hovered(){}unhovered(){}clicked(){}released(){this.isHovering()&&(this.risq.toggleRightPanel(),this.setHovering(!1))}}class J{constructor(t,e){this.opening=!1,this.hovering=!1,this.risq=t,this.config=e,this.open_button=new X(t),this.toggle(e.is_open,!0)}isHovering(){return this.hovering}isClicking(){return!1}isOpen(){return this.config.is_open}toggle(t,e){this.config.is_open=null!=t?t:!this.config.is_open;const i={x:this.risq.canvasSize().width-this.open_button.w(),y:.5*this.open_button.h()};this.config.is_open&&(i.x-=this.config.w),this.opening=!0,this.open_button.setPosition(i,(()=>{this.opening=!1;const t={direction:this.config.is_open,angle:this.config.is_open?.5*Math.PI:-.5*Math.PI};this.open_button.setRotation(t,void 0,e)}),e)}draw(t,e,i){(this.opening||this.config.is_open)&&Y(t,e,{fill_style:this.config.background,stroke_style:"transparent",stroke_width:0,fixed_position:!0},!1,!1,(()=>{if(a(t,{x:this.xi(),y:this.yi()},this.w(),this.h()),!this.opening&&this.config.is_open){h(t,`Turn ${this.risq.getGame().turn_number}`,{p:{x:this.xc(),y:this.yi()},w:this.w(),fill_style:"black",align:"center",font:"bold 36px serif"});let e=this.yi()+40;const i=this.risq.getPlayer();if(this.drawSeparator(t,e),e+=5,i){if(t.font="24px serif",this.drawPopulation(t,e,i.units.size,i.population_limit),e+=30,i)for(const[s,o]of[...i.resources.entries()].sort(((t,e)=>t[0]-e[0])))this.drawResource(t,e,s,o),e+=30;e+=5,this.drawSeparator(t,e),e+=5}for(const i of this.risq.getGame().scores)this.drawScore(t,e,i)}})),this.open_button.draw(t,e,i)}drawSeparator(t,e){t.strokeStyle="rgba(60, 60, 60, 0.6)",t.lineWidth=2,n(t,{x:this.xi()+.15*this.w(),y:e},{x:this.xf()-.15*this.w(),y:e})}drawPopulation(t,e,i,s){t.beginPath(),t.drawImage(this.risq.getIcon("icons/person64"),this.xi()+.1*this.w(),e,30,30),h(t,`${i}/${s}`,{p:{x:this.xi()+.1*this.w()+36,y:e+15},w:.9*this.w()-36,fill_style:"black",baseline:"middle"})}drawResource(t,e,i,s){t.beginPath(),t.drawImage(this.risq.getIcon(I(i)),this.xi()+.1*this.w(),e,30,30),h(t,s.toString(),{p:{x:this.xi()+.1*this.w()+36,y:e+15},w:.9*this.w()-36,fill_style:"black",baseline:"middle"})}drawScore(t,e,i){t.beginPath(),h(t,`${i.nickname}: ${i.score}`,{p:{x:this.xi()+.9*this.w(),y:e+15},w:.8*this.w(),fill_style:i.color.getString(),baseline:"middle",align:"right"})}mousemove(t,e){return!!this.open_button.mousemove(t,e)||((t={x:t.x*e.scale-e.view.x,y:t.y*e.scale-e.view.y}).x>this.xi()&&t.y>this.yi()&&t.x<this.xf()&&t.y<this.yf()?this.hovering=!0:this.hovering=!1,this.isHovering())}mousedown(t){return!!this.open_button.mousedown(t)||this.isHovering()}mouseup(t){this.open_button.mouseup(t)}xi(){return this.open_button.xf()}yi(){return 0}xf(){return this.risq.canvasSize().width}yf(){return this.risq.canvasSize().height}xc(){return this.xi()+.5*this.w()}yc(){return this.yi()+.5*this.h()}w(){return this.xf()-this.xi()}h(){return this.yf()-this.yi()}}!function(t){t[t.OWNERSHIP=0]="OWNERSHIP",t[t.SPACE_DETAILS=1]="SPACE_DETAILS",t[t.ZONE_DETAILS=2]="ZONE_DETAILS"}(R||(R={}));const Q=new Map([[R.OWNERSHIP,3],[R.SPACE_DETAILS,2],[R.ZONE_DETAILS,1.2]]);function tt(t,e,i,s){var r,a,n;t.strokeStyle="rgba(250, 250, 250, 0.9)";const h=et(i);t.fillStyle=h.getString(),t.lineWidth=Q.get(s.draw_detail),o(t,i.center,s.hex_r),t.textAlign="left";const c=h.getBrightness()>.5;if(s.draw_detail!==R.OWNERSHIP)if(s.draw_detail===R.SPACE_DETAILS){if(i.visibility<2)return;let o=e.getIcon("icons/building64"),h=e.getIcon("icons/villager64"),l=e.getIcon("icons/unit64");c?t.fillStyle="black":(t.fillStyle="white",o=e.getIcon("icons/building_white64"),h=e.getIcon("icons/villager_white64"),l=e.getIcon("icons/unit_white64")),t.textBaseline="top",t.font=`bold ${s.inset_row}px serif`;const d=i.center.x-.5*s.inset_w,_=i.center.y-.5*s.inset_h;t.drawImage(o,d,_,s.inset_row,s.inset_row),t.fillText(`: ${null===(r=i.buildings)||void 0===r?void 0:r.size.toString()}`,d+s.inset_row+2,_,s.inset_w-s.inset_row-2);const u=i.center.y-.5*s.inset_h+s.inset_row+2;t.drawImage(h,d,u,s.inset_row,s.inset_row),t.fillText(`: ${null===(a=i.num_villager_units)||void 0===a?void 0:a.toString()}`,d+s.inset_row+2,u,s.inset_w-s.inset_row-2);const g=i.center.y-.5*s.inset_h+2*(s.inset_row+2);t.drawImage(l,d,g,s.inset_row,s.inset_row),t.fillText(`: ${null===(n=i.num_military_units)||void 0===n?void 0:n.toString()}`,d+s.inset_row+2,g,s.inset_w-s.inset_row-2)}else if(s.draw_detail===R.ZONE_DETAILS){if(i.visibility<3)return;t.translate(i.center.x,i.center.y);let r=i.zones[1][1];t.strokeStyle="rgba(250, 250, 250, 0.9)",t.lineWidth=.1,t.fillStyle=E(r).getString();const a=s.hex_r,n=.4*a;let h=.45*a;o(t,{x:0,y:0},n),P(t,e,r,c,h,0,{x:.18*a*Math.cos(3*Math.PI/6),y:.18*a*Math.sin(3*Math.PI/6)},{x:.18*a*Math.cos(7*Math.PI/6),y:.18*a*Math.sin(7*Math.PI/6)},{x:.18*a*Math.cos(11*Math.PI/6),y:.18*a*Math.sin(11*Math.PI/6)}),h=.43*a;const d=Math.PI/3;for(var l=0;l<6;l++){let s={x:0,y:0};switch(l){case 0:s={x:2,y:1};break;case 1:s={x:2,y:0};break;case 2:s={x:1,y:0};break;case 3:s={x:0,y:0};break;case 4:s={x:0,y:1};break;case 5:s={x:1,y:2}}r=i.zones[s.x][s.y],t.strokeStyle="rgba(250, 250, 250, 0.9)",t.fillStyle=E(r).getString(),t.beginPath(),t.lineTo(n*Math.cos(d*l+Math.PI/6),n*Math.sin(d*l+Math.PI/6)),t.lineTo(n*Math.cos(d*l+Math.PI/2),n*Math.sin(d*l+Math.PI/2)),t.lineTo(a*Math.cos(d*l+Math.PI/2),a*Math.sin(d*l+Math.PI/2)),t.lineTo(a*Math.cos(d*l+Math.PI/6),a*Math.sin(d*l+Math.PI/6)),t.closePath(),t.stroke(),t.fill();const o=d*(1+l);t.rotate(o);const _=Math.PI/12;P(t,e,r,c,h,o,{x:.73*a*Math.cos(0),y:.76*a*Math.sin(0)},{x:.53*a*Math.cos(-_),y:.53*a*Math.sin(-_)},{x:.53*a*Math.cos(_),y:.53*a*Math.sin(_)}),t.rotate(-o)}t.translate(-i.center.x,-i.center.y)}}function et(t,e=!0){const i=new m(0,0,0,0);return t&&(i.setColor(90,90,90,.8),t.visibility>0?(i.setColor(10,120,10,.8),e&&t.hovered&&(t.clicked?i.addColor(210,210,210,.4):i.addColor(190,190,190,.2))):t.hovered&&i.addColor(150,150,150,.1)),i}class it extends K{constructor(t){super({button_config:{only_left_click:!0},p:{x:0,y:0},s:36,draw_config:{fill_style:"transparent",stroke_style:"transparent",stroke_width:0,hover_fill_style:"rgb(180, 180, 180, 0.5)",click_fill_style:"rgb(210, 210, 210, 0.7)",fixed_position:!0},image_path:"icons/close_gray32"}),this.risq=t}hovered(){}unhovered(){}clicked(){}released(){this.isHovering()&&(this.risq.closeLeftPanel(),this.setHovering(!1))}}var st,ot;!function(t){t[t.RESOURCE=0]="RESOURCE",t[t.BUILDING=1]="BUILDING",t[t.SPACE=2]="SPACE",t[t.ZONE=3]="ZONE",t[t.MULTIPLE_PLAYERS_UNITS=4]="MULTIPLE_PLAYERS_UNITS",t[t.UNITS=5]="UNITS",t[t.UNITS_BY_TYPE=6]="UNITS_BY_TYPE",t[t.ECONOMIC_UNITS=7]="ECONOMIC_UNITS",t[t.MILITARY_UNITS=8]="MILITARY_UNITS",t[t.UNIT=9]="UNIT"}(st||(st={})),function(t){t[t.NONE=0]="NONE",t[t.UNIT=1]="UNIT",t[t.BUILDING=2]="BUILDING",t[t.RESOURCE=3]="RESOURCE"}(ot||(ot={}));class rt{constructor(t,e){this.showing=!1,this.hovering=!1,this.buttons=[],this.hovered_object_type=ot.NONE,this.hexagon_r=0,this.hexagon_c={x:0,y:0},this.risq=t,e.w<1&&(e.w=120),this.config=e,this.close_button=new it(t),this.resolveSize()}resolveSize(){let t=4*this.config.w;t>this.risq.canvasSize().height&&(t=this.risq.canvasSize().height),this.size={x:t/3,y:t},this.close_button.setPosition({x:this.size.x,y:this.yi()+.5*this.close_button.h()})}isHovering(){return this.hovering}isClicking(){return!1}isShowing(){return this.showing}close(){this.showing=!1,this.data_type=void 0,this.visibility=void 0,this.data=void 0,this.hovered_zone=void 0}openPanel(t,e,i){if(!(e<1||e<3&&[st.RESOURCE,st.BUILDING,st.ZONE,st.MULTIPLE_PLAYERS_UNITS,st.UNITS,st.UNITS_BY_TYPE,st.ECONOMIC_UNITS,st.MILITARY_UNITS,st.UNIT].includes(t)))switch(this.data_type=t,this.visibility=e,this.data=i,this.showing=!0,t){case st.MULTIPLE_PLAYERS_UNITS:case st.UNITS:case st.ECONOMIC_UNITS:case st.MILITARY_UNITS:this.checkUnitsData(i);break;case st.UNITS_BY_TYPE:this.checkUnitsByTypeData(i)}}checkUnitsData(t){if(!t||!t.space||!t.space.units||!t.units||t.units.size<1)return void this.close();const e=[];for(const[i,s]of t.units.entries())i<0||s.length<1||e.push([i,s.filter((t=>t.units.size>0))]);if(!(e.length<1))return e.length>1?(this.data_type=st.MULTIPLE_PLAYERS_UNITS,void(this.data={space:t.space,units:e})):void this.checkUnitsByTypeData({space:t.space,units:e[0][1]});this.close()}checkUnitsByTypeData(t){if(1===t.units.length&&1===t.units[0].units.size)return this.data_type=st.UNIT,void(this.data=t.space.units.get([...t.units[0].units.values()][0]));this.data={space:t.space,units:t.units};const e=t.units.some((t=>t.unit_id<11)),i=t.units.some((t=>t.unit_id>10));e&&i?this.data_type=st.UNITS:e?this.data_type=st.ECONOMIC_UNITS:i&&(this.data_type=st.MILITARY_UNITS)}draw(t,e,i){this.isShowing()&&(Y(t,e,{fill_style:this.config.background,stroke_style:"transparent",stroke_width:0,fixed_position:!0},!1,!1,(()=>{switch(a(t,{x:this.xi(),y:this.yi()},this.w(),this.h()),this.data_type){case st.RESOURCE:this.drawResource(t,this.data);break;case st.BUILDING:this.drawBuilding(t,this.data);break;case st.SPACE:this.drawSpace(t,this.data);break;case st.ZONE:this.drawZone(t,this.data);break;case st.MULTIPLE_PLAYERS_UNITS:break;case st.UNITS:case st.ECONOMIC_UNITS:case st.MILITARY_UNITS:this.drawUnits(t,this.data);break;case st.UNIT:this.drawUnit(t,this.data);break;default:console.error("Unknown data type for left panel",this.data_type)}for(const s of this.buttons)s.draw(t,e,i)})),t.beginPath(),this.close_button.draw(t,e,i))}drawUnitImage(t,e,i,s){t.drawImage(this.risq.getIcon(M(e)),i.x,i.y,s,s),t.strokeStyle=S,t.lineWidth=.4,t.fillStyle=S,a(t,{x:i.x,y:i.y+.8*s},s,.18*s),e.combat_stats.max_health>0&&e.combat_stats.health>0&&(t.fillStyle=z,a(t,{x:i.x,y:i.y+.8*s},e.combat_stats.health/e.combat_stats.max_health*s,.2*s)),e.hover_data.hovered&&(e.hover_data.clicked?t.fillStyle="rgba(250, 250, 250, 0.4)":t.fillStyle="rgba(220, 220, 220, 0.2)",t.strokeStyle="transparent",a(t,i,s,s)),e.hover_data.ps=i,e.hover_data.pe={x:i.x+s,y:i.y+s}}drawUnits(t,e){const i=e.units.map((t=>t.units.size)).reduce(((t,e)=>t+e));let s=this.yi()+this.drawName(t,`${i} Units`);const o=i<40?64:36,r=Math.floor(.8*this.w()/(1.3*o));if(r<1)return;const a=e.units.map((t=>Math.ceil(t.units.size/r))).reduce(((t,e)=>t+e)),n=this.yi()+.5*this.size.y-8-s;if(a>Math.floor(n/(o+8)));else{s=this.yi()+.5*this.size.y-a*(o+8);for(const i of e.units){if(i.units.size<1)continue;let a=0;for(const n of i.units.values()){const i=e.space.units.get(n);if(!i)continue;a>=r&&(a=0,s+=o+8);const h=this.xi()+.1*this.w()+a*(o+8);this.drawUnitImage(t,i,{x:h,y:s},o),a++}s+=o+8}}this.risq.getPlayer().player.player_id===e.units[0].player_id&&(this.drawSeparator(t,this.yi()+.5*this.size.y),this.drawSeparator(t,this.yi()+.75*this.size.y))}drawUnit(t,e){let i=this.yi()+this.drawName(t,e.display_name);i+=this.drawImage(t,i,M(e)),this.drawSeparator(t,i),i=this.yi()+.25*this.size.y+6,this.drawCombatStats(t,i,i+.25*this.size.y-12,e.combat_stats),this.risq.getPlayer().player.player_id===e.player_id&&(this.drawSeparator(t,this.yi()+.5*this.size.y),this.drawSeparator(t,this.yi()+.75*this.size.y))}drawResource(t,e){let i=this.yi()+this.drawName(t,e.display_name);i+=this.drawImage(t,i,w(e)),this.drawSeparator(t,i),i+=8,t.beginPath(),t.drawImage(this.risq.getIcon(I(e)),this.xi()+.1*this.w(),i,40,40),h(t,this.visibility<4?"??":e.resources_left.toString(),{p:{x:this.xi()+.1*this.w()+48,y:i+20},w:.9*this.w()-48,fill_style:"black",baseline:"middle",font:"36px serif"}),i+=50,h(t,`Base gather speed: ${e.base_gather_speed}`,{p:{x:this.xi()+.1*this.w(),y:i+12},w:.9*this.w(),fill_style:"black",baseline:"middle",font:"18px serif"})}drawBuilding(t,e){var i;let s=this.yi()+this.drawName(t,null!==(i=null==e?void 0:e.display_name)&&void 0!==i?i:"Empty Plot");if(s+=this.drawImage(t,s,k(e)),this.drawSeparator(t,s),!e)return s+=12,void h(t,"An empty lot that can be built on",{p:{x:this.xi()+.1*this.w(),y:s},w:.9*this.w(),fill_style:"black",align:"left",font:"14px serif"});s=this.yi()+.25*this.size.y+6,this.drawCombatStats(t,s,s+.25*this.size.y-12,e.combat_stats),this.risq.getPlayer().player.player_id===e.player_id&&(this.drawSeparator(t,this.yi()+.5*this.size.y),this.drawSeparator(t,this.yi()+.75*this.size.y))}drawSpace(t,e){var i,s,o;let r=this.yi()+this.drawName(t,A(e.terrain));if(h(t,"space",{p:{x:this.xc(),y:r},w:this.w(),fill_style:"black",align:"center",font:"18px serif"}),r+=26,r+=this.drawSpaceHexagon(t,e,8,r),this.drawSeparator(t,r),r+=8,this.visibility>=2){const a=4,n=Math.min(36,1/a*(.6*this.h()-8-8*(a-1)));t.fillStyle="black";const c=(e,i)=>{t.drawImage(e,this.xi()+.1*this.w(),r,n,n),h(t,`: ${i}`,{p:{x:this.xi()+.1*this.w()+n+2,y:r},w:.9*this.w()-n-2,fill_style:"black",align:"left",font:`bold ${n}px serif`}),r+=n+8};c(this.risq.getIcon("icons/building64"),null===(i=e.buildings)||void 0===i?void 0:i.size.toString()),c(this.risq.getIcon("icons/villager64"),null===(s=e.num_villager_units)||void 0===s?void 0:s.toString()),c(this.risq.getIcon("icons/unit64"),null===(o=e.num_military_units)||void 0===o?void 0:o.toString());const l=[...e.total_resources.entries()].filter((t=>t[1]>0)).map((t=>t[0])).sort(((t,e)=>t-e)),d=l.length+.3*(l.length-1),_=Math.min(n,1/d*.8*this.w());for(const[e,i]of l.entries())e>0&&h(t,"/",{p:{x:this.xi()+.1*this.w()+(1.3*e-.15)*_,y:r},w:.3*_,fill_style:"black",align:"center",font:`bold ${_}px serif`}),t.drawImage(this.risq.getIcon(I(i)),this.xi()+.1*this.w()+1.3*e*_,r,_,_);r+=n+8}}drawSpaceHexagon(t,e,i,s,r={x:-1,y:-1}){const a=Math.min(this.w(),this.yi()+.4*this.h()-s-i);t.strokeStyle="rgba(250, 250, 250, 1)",t.lineWidth=2,t.fillStyle=et(e,!1).getString();const n=.5*a;this.hexagon_r=n;const h=.4*n,c={x:this.xc(),y:s+n};if(this.hexagon_c=c,o(t,c,n),this.visibility>=3){t.strokeStyle="rgba(250, 250, 250, 0.7)",t.lineWidth=.5;let i=e.zones[1][1];const s=E(i,!0,4);1===r.x&&1===r.y?s.addColor(255,255,255,.2):s.dAlpha(-.2),t.fillStyle=s.getString(),o(t,c,h);const a=Math.PI/3;for(var l=0;l<6;l++){let s={x:0,y:0};switch(l){case 0:s={x:2,y:1};break;case 1:s={x:2,y:0};break;case 2:s={x:1,y:0};break;case 3:s={x:0,y:0};break;case 4:s={x:0,y:1};break;case 5:s={x:1,y:2}}i=e.zones[s.x][s.y];const o=E(i,!0,4);r.x===s.x&&r.y===s.y?o.addColor(255,255,255,.2):o.dAlpha(-.2),t.fillStyle=o.getString(),t.beginPath(),t.lineTo(c.x+h*Math.cos(a*l+Math.PI/6),c.y+h*Math.sin(a*l+Math.PI/6)),t.lineTo(c.x+h*Math.cos(a*l+Math.PI/2),c.y+h*Math.sin(a*l+Math.PI/2)),t.lineTo(c.x+n*Math.cos(a*l+Math.PI/2),c.y+n*Math.sin(a*l+Math.PI/2)),t.lineTo(c.x+n*Math.cos(a*l+Math.PI/6),c.y+n*Math.sin(a*l+Math.PI/6)),t.closePath(),t.stroke(),t.fill()}}return a+i}drawZone(t,e){var i,s,o;let r=this.yi()+this.drawName(t,A(e.space.terrain));h(t,"zone",{p:{x:this.xc(),y:r},w:this.w(),fill_style:"black",align:"center",font:"18px serif"}),r+=26,r+=this.drawSpaceHexagon(t,e.space,8,r,$(1,e.zone.coordinate)),this.drawSeparator(t,r),r+=8;const n=1.3,c=Math.floor((.8*this.w()-57.6)/(36*n)),l=Math.ceil(e.zone.economic_units.length/c),d=Math.ceil(e.zone.military_units.length/c),_=1+l+d,u=Math.min(36,1/_*(.6*this.h()-8-8*(_-1)));t.fillStyle="black";const g=(e,i,s)=>{const o={x:this.xi()+.1*this.w(),y:r},n={x:o.x+.8*this.w(),y:o.y+u};(null==s?void 0:s.hovered)&&(t.strokeStyle="transparent",(null==s?void 0:s.clicked)?t.fillStyle="rgba(250, 250, 250, 0.4)":t.fillStyle="rgba(210, 210, 210, 0.25)",a(t,o,n.x-o.x,n.y-o.y)),t.drawImage(e,o.x,o.y,u,u),h(t,`: ${i}`,{p:{x:o.x+u+2,y:r+.5*u},w:.8*this.w()-u-2,fill_style:"black",align:"left",baseline:"middle",font:`bold ${u}px serif`}),s&&(s.ps=o,s.pe=n)};e.zone.resource?g(this.risq.getIcon(w(e.zone.resource)),e.zone.resource.display_name,e.zone.resource.hover_data):g(this.risq.getIcon(k(e.zone.building)),null!==(s=null===(i=e.zone.building)||void 0===i?void 0:i.display_name)&&void 0!==s?s:"Empty Plot",null===(o=e.zone.building)||void 0===o?void 0:o.hover_data),r+=u+8;let y=this.xi()+.1*this.w()+.6*u;if(e.zone.economic_units.length>0){g(this.risq.getIcon("icons/villager64"),"");let i=1,s=0;for(const o of e.zone.economic_units){const a={x:y+i*n*u,y:r+s*n*u};this.drawUnitImage(t,e.zone.units.get(o),a,u),i++,i>c&&(i=1,s++)}r+=l*n*u+8}if(e.zone.military_units.length>0){g(this.risq.getIcon("icons/unit64"),"");let i=1,s=0;for(const o of e.zone.military_units){const a={x:y+i*n*u,y:r+s*n*u};this.drawUnitImage(t,e.zone.units.get(o),a,u),i++,i>c&&(i=1,s++)}r+=d*n*u+8}}drawName(t,e){const i=Math.min(40,1/12*this.size.y);return h(t,e,{p:{x:this.xc(),y:this.yi()},w:this.w(),fill_style:"black",align:"center",font:`bold ${.85*i}px serif`}),i}drawImage(t,e,i){t.beginPath();const s=.25*this.size.y-e+this.yi(),o=Math.min(s-6,.8*this.w());return t.drawImage(this.risq.getIcon(i),.5*(this.w()-o),e,o,o),s}drawSeparator(t,e){t.strokeStyle="rgba(60, 60, 60, 0.7)",t.lineWidth=2,n(t,{x:this.xi()+.1*this.w(),y:e},{x:this.xf()-.1*this.w(),y:e})}drawCombatStats(t,e,i,s){if(!(i-e>20))return;const o=1/4*(i-e);e+=4;const r=this.xi()+.1*this.w(),n=Math.min(14,.4*o);t.strokeStyle=S,t.lineWidth=.4,t.fillStyle=S,a(t,{x:r,y:e},.8*this.w(),n),s.max_health>0&&s.health>0&&(t.fillStyle=z,a(t,{x:r,y:e},s.health/s.max_health*.8*this.w(),n)),h(t,`${s.health} / ${s.max_health}`,{p:{x:r,y:e+n+.1*o},w:.8*this.w(),fill_style:"black",align:"left",font:`${n}px serif`}),e+=o+4;const c=i=>{let s=this.xi()+.1*this.w();const r=.8*this.w()/i.length,a=Math.min(.7*o,.3*r);let n=!1;for(const o of i.filter((t=>!!t[1])))n=!0,t.drawImage(this.risq.getIcon(o[0]),s,e,a,a),h(t,o[1].toString(),{p:{x:s+a+.1*r,y:e+.5*a},w:r-a,fill_style:"black",align:"left",baseline:"middle",font:.9*a+"px serif"}),s+=r;n&&(e+=o+4)};s.attack_type!==U.NONE&&(c([["risq/icons/attack_blunt",s.attack_blunt],["risq/icons/attack_piercing",s.attack_piercing],["risq/icons/attack_magic",s.attack_magic]]),c([["risq/icons/penetration_blunt",s.penetration_blunt],["risq/icons/penetration_piercing",s.penetration_piercing],["risq/icons/penetration_magic",s.penetration_magic]])),c([["risq/icons/defense_blunt",s.defense_blunt],["risq/icons/defense_piercing",s.defense_piercing],["risq/icons/defense_magic",s.defense_magic]])}objectHoverLogic(t,e,i){return!!e&&(t.x<e.hover_data.ps.x||t.y<e.hover_data.ps.y||t.x>e.hover_data.pe.x||t.y>e.hover_data.pe.y?(e.hover_data.hovered=!1,!1):(!this.hovered_object||this.hovered_object.internal_id===e.internal_id&&this.hovered_object_type===i||(this.hovered_object.hover_data.hovered=!1,this.hovered_object.hover_data.clicked=!1),e.hover_data.hovered=!0,this.hovered_object=e,this.hovered_object_type=e?i:ot.NONE,!0))}mousemove(t,e){var i,s,o,r;if(this.close_button.mousemove(t,e))return!0;switch((t={x:t.x*e.scale-e.view.x,y:t.y*e.scale-e.view.y}).x>this.xi()&&t.y>this.yi()&&t.x<this.xf()&&t.y<this.yf()?this.hovering=!0:this.hovering=!1,this.data_type){case st.SPACE:case st.ZONE:const e=N(t,this.data_type===st.SPACE?this.data:this.data.space,this.hexagon_r,this.hexagon_c,!0);if(this.hovered_zone&&!c(this.hovered_zone.coordinate,null==e?void 0:e.coordinate)&&(this.hovered_zone.hovered=!1,this.hovered_zone.clicked=!1),this.hovered_zone=e,this.data_type===st.ZONE){const e=[...this.data.zone.economic_units,...this.data.zone.military_units];for(const s of e)this.objectHoverLogic(t,null===(i=this.data.zone)||void 0===i?void 0:i.units.get(s),ot.UNIT);this.objectHoverLogic(t,null===(s=this.data.zone)||void 0===s?void 0:s.resource,ot.RESOURCE),this.objectHoverLogic(t,null===(o=this.data.zone)||void 0===o?void 0:o.building,ot.BUILDING)}break;case st.UNITS:case st.ECONOMIC_UNITS:case st.MILITARY_UNITS:for(const e of this.data.units)if(!(e.units.size<1))for(const i of e.units.values())this.objectHoverLogic(t,null===(r=this.data.space)||void 0===r?void 0:r.units.get(i),ot.UNIT)}for(const i of this.buttons)i.mousemove(t,e);return this.isHovering()}mousedown(t){if(this.close_button.mousedown(t))return!0;switch(this.data_type){case st.SPACE:case st.ZONE:this.hovered_zone?this.hovered_zone.clicked=!0:this.hovered_object&&(this.hovered_object.hover_data.clicked=!0);break;case st.UNITS:case st.ECONOMIC_UNITS:case st.MILITARY_UNITS:this.hovered_object&&(this.hovered_object.hover_data.clicked=!0)}for(const e of this.buttons)e.mousedown(t);return this.isHovering()}mouseup(t){switch(this.close_button.mouseup(t),this.data_type){case st.SPACE:case st.ZONE:const e=this.data_type===st.SPACE?this.data:this.data.space;if(this.hovered_zone&&this.hovered_zone.clicked)this.hovered_zone.clicked=!1,this.hovered_zone.hovered&&this.openPanel(st.ZONE,this.visibility,{space:e,zone:this.hovered_zone});else if(this.hovered_object&&this.hovered_object.hover_data.clicked&&(this.hovered_object.hover_data.clicked=!1,this.hovered_object.hover_data.hovered))switch(this.hovered_object_type){case ot.UNIT:if(t.shiftKey){const t=this.data.zone.units_by_type.get(this.hovered_object.player_id);t&&this.openPanel(st.UNITS_BY_TYPE,this.visibility,{space:e,units:[...t.values()].filter((t=>t.unit_id===this.hovered_object.unit_id))})}else this.openPanel(st.UNIT,this.visibility,this.hovered_object);break;case ot.BUILDING:this.openPanel(st.BUILDING,this.visibility,this.hovered_object);break;case ot.RESOURCE:this.openPanel(st.RESOURCE,this.visibility,this.hovered_object)}break;case st.UNITS:case st.ECONOMIC_UNITS:case st.MILITARY_UNITS:this.hovered_object&&this.hovered_object.hover_data.clicked&&(this.hovered_object.hover_data.clicked=!1,this.hovered_object.hover_data.hovered&&(t.shiftKey?this.openPanel(st.UNITS_BY_TYPE,this.visibility,{space:this.data.space,units:this.data.units.filter((t=>t.unit_id===this.hovered_object.unit_id))}):this.openPanel(st.UNIT,this.visibility,this.hovered_object)))}for(const e of this.buttons)e.mouseup(t)}xi(){return 0}yi(){return.5*(this.risq.canvasSize().height-this.size.y)}xf(){return this.showing?this.xi()+this.w():0}yf(){return this.showing?this.yi()+this.h():0}xc(){return this.xi()+.5*this.w()}yc(){return this.yi()+.5*this.h()}w(){return this.size.x}h(){return this.size.y}}var at=i(3379),nt=i.n(at),ht=i(7795),ct=i.n(ht),lt=i(569),dt=i.n(lt),_t=i(3565),ut=i.n(_t),gt=i(9216),yt=i.n(gt),vt=i(4589),ft=i.n(vt),xt=i(3217),pt={};pt.styleTagTransform=ft(),pt.setAttributes=ut(),pt.insert=dt().bind(null,"head"),pt.domAPI=ct(),pt.insertStyleElement=yt(),nt()(xt.Z,pt),xt.Z&&xt.Z.locals&&xt.Z.locals;var mt=i(5254),wt={};wt.styleTagTransform=ft(),wt.setAttributes=ut(),wt.insert=dt().bind(null,"head"),wt.domAPI=ct(),wt.insertStyleElement=yt(),nt()(mt.Z,wt),mt.Z&&mt.Z.locals&&mt.Z.locals;var bt=function(t,e,i,s){return new(i||(i=Promise))((function(o,r){function a(t){try{h(s.next(t))}catch(t){r(t)}}function n(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,n)}h((s=s.apply(t,e||[])).next())}))};class It extends s.r{constructor(){super(),this.transform={scale:1,view:{x:0,y:0}},this.hovered=!1,this.holding_keys={arrow_up:!1,arrow_down:!1,arrow_left:!1,arrow_right:!1},this.cursor_move_threshold=5,this.dragging=!1,this.mouse={x:0,y:0},this.cursor_in_range=!1,this.resize_observer=new ResizeObserver((t=>bt(this,void 0,void 0,(function*(){for(const e of t)yield this.updateSize(this.data,e.contentRect),this.dispatchEvent(new CustomEvent("canvas_resize",{detail:{board_size:this.data.board_size,el_size:this.bounding_rect},bubbles:!0}))})))),this.htmlString=' <canvas id="canvas">Board</canvas> <img id="cursor" alt="cursor" draggable="false"> ',this.configureElement("canvas"),this.configureElement("cursor")}getBoundingRect(){return this.bounding_rect}initialize(t){var e;return bt(this,void 0,void 0,(function*(){if(t.allow_side_move=null===(e=t.allow_side_move)||void 0===e||e,this.zoom_config=Object.assign({},t.zoom_config),this.orig_size={x:t.board_size.x,y:t.board_size.y},yield this.updateSize(t))return this.cursor.src="/images/cursors/cursor.png",this.addEventListeners(),yield(0,x.C4)((()=>{var t;return!!(null===(t=this.canvas.getBoundingClientRect())||void 0===t?void 0:t.width)})),this.resize_observer.observe(this),setInterval((()=>{this.tick(),this.ctx.resetTransform(),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.data.board_size.x,this.data.board_size.y),this.ctx.translate(-this.transform.view.x,-this.transform.view.y),this.ctx.scale(this.transform.scale,this.transform.scale),this.data.draw(this.ctx,this.transform)}),20),{board_size:this.data.board_size,el_size:this.bounding_rect}}))}updateSize(t,e){return bt(this,void 0,void 0,(function*(){return!t||this.orig_size.x<1||this.orig_size.y<1?(console.error("Size must be at least 1px in each direction"),!1):!t.max_scale||t.max_scale<1?(console.error(`Max scale of ${t.max_scale} is invalid`),!1):(this.data=t,yield(0,x.C4)((()=>this.fully_parsed)),this.canvas.getContext?(yield this.setSize(e),!0):(console.error("Browser does not support canvas; cannot draw board"),!1))}))}setSize(t){return bt(this,void 0,void 0,(function*(){const e=this.data;if(t?this.bounding_rect=t:(yield(0,x.C4)((()=>{var t;return this.bounding_rect=this.getBoundingClientRect(),!!(null===(t=this.bounding_rect)||void 0===t?void 0:t.width)})),t=this.bounding_rect),e.fill_space){const i=this.orig_size.x/this.orig_size.y;e.board_size.x=Math.max(this.orig_size.x,t.width),e.board_size.y=Math.max(this.orig_size.y,t.height),e.board_size.x/e.board_size.y>i?e.board_size.y=e.board_size.x/i:e.board_size.x=e.board_size.y*i}this.ctx=this.canvas.getContext("2d"),this.canvas.style.setProperty("--w",`${e.board_size.x.toString()}px`),this.canvas.style.setProperty("--h",`${e.board_size.y.toString()}px`),this.canvas.width=e.board_size.x,this.canvas.height=e.board_size.y}))}addEventListeners(){this.addEventListener("wheel",(t=>{let e=1+t.deltaY/this.zoom_config.zoom_constant;this.zoom_config.max_zoom&&this.zoom_config.max_zoom<e&&(e=this.zoom_config.max_zoom),this.zoom_config.min_zoom&&this.zoom_config.min_zoom>e&&(e=this.zoom_config.min_zoom),this.setScale(this.transform.scale/e),this.data.mousemove({x:(this.mouse.x+this.transform.view.x)/this.transform.scale,y:(this.mouse.y+this.transform.view.y)/this.transform.scale},this.transform)})),this.addEventListener("mousemove",(t=>{this.hovered=!0,this.cursor.style.setProperty("--x",`${t.clientX.toString()}px`),this.cursor.style.setProperty("--y",`${t.clientY.toString()}px`);const e=this.canvas.getBoundingClientRect(),i={x:t.clientX-e.left,y:t.clientY-e.top},s=d(i,this.mouse);this.mouse=i,this.dragging?this.setView(d(this.transform.view,s)):this.data.mousemove({x:(this.mouse.x+this.transform.view.x)/this.transform.scale,y:(this.mouse.y+this.transform.view.y)/this.transform.scale},this.transform)})),this.addEventListener("mousedown",(t=>{t.stopImmediatePropagation(),this.data.mousedown(t)||(this.dragging=!0)})),this.addEventListener("mouseup",(t=>{t.stopImmediatePropagation(),this.dragging=!1,this.data.mouseup(t)})),this.addEventListener("mouseenter",(()=>{this.hovered=!0,this.cursor.classList.remove("hide")})),this.addEventListener("mouseleave",(()=>{this.hovered=!1,this.dragging=!1,this.cursor.classList.add("hide"),this.data.mouseleave()})),this.addEventListener("contextmenu",(t=>{t.preventDefault()}),!1),document.body.addEventListener("keydown",(t=>{if(this.hovered)switch(t.key){case"ArrowUp":this.holding_keys.arrow_up=!0;break;case"ArrowDown":this.holding_keys.arrow_down=!0;break;case"ArrowLeft":this.holding_keys.arrow_left=!0;break;case"ArrowRight":this.holding_keys.arrow_right=!0}})),document.body.addEventListener("keyup",(t=>{if(this.hovered)switch(t.key){case"ArrowUp":this.holding_keys.arrow_up=!1;break;case"ArrowDown":this.holding_keys.arrow_down=!1;break;case"ArrowLeft":this.holding_keys.arrow_left=!1;break;case"ArrowRight":this.holding_keys.arrow_right=!1}}))}tick(){const t={x:0,y:0},e=20*this.transform.scale;let i=!1;const s=this.canvas.getBoundingClientRect();if(this.holding_keys.arrow_up&&(t.y-=e,i=!0),this.holding_keys.arrow_down&&(t.y+=e,i=!0),this.holding_keys.arrow_left&&(t.x-=e,i=!0),this.holding_keys.arrow_right&&(t.x+=e,i=!0),!this.dragging&&this.data.allow_side_move){const o=!this.cursor_in_range&&!i;this.mouse.y<this.cursor_move_threshold&&(t.y-=e,i=!0),this.mouse.y>s.height-this.cursor_move_threshold&&(t.y+=e,i=!0),this.mouse.x<this.cursor_move_threshold&&(t.x-=e,i=!0),this.mouse.x>s.width-this.cursor_move_threshold&&(t.x+=e,i=!0),o&&(i?i=!1:this.cursor_in_range=!0)}i&&(this.setView({x:this.transform.view.x+t.x,y:this.transform.view.y+t.y}),this.data.mousemove({x:(this.mouse.x+this.transform.view.x)/this.transform.scale,y:(this.mouse.y+this.transform.view.y)/this.transform.scale},this.transform))}scaleView(t){this.setView({x:this.transform.view.x*t,y:this.transform.view.y*t})}setView(t){isNaN(t.x)||isNaN(t.y)||(t.x<0?t.x=0:t.x>this.data.board_size.x*this.transform.scale&&(t.x=this.data.board_size.x*this.transform.scale),t.y<0?t.y=0:t.y>this.data.board_size.y*this.transform.scale&&(t.y=this.data.board_size.y*this.transform.scale),this.transform.view=t)}getMaxScale(){return this.data.max_scale}setMaxScale(t){if(!t||t<1)return;const e=t/this.data.max_scale;this.data.max_scale=t,e?this.transform.scale>1?this.setScale(this.transform.scale*e):this.transform.scale<1&&this.setScale(this.transform.scale/e):this.setScale(this.transform.scale)}setScale(t){return t?(t<1/this.data.max_scale?t=1/this.data.max_scale:t>this.data.max_scale&&(t=this.data.max_scale),this.transform.view.x*=t/this.transform.scale,this.transform.view.y*=t/this.transform.scale,this.transform.scale=t,t):this.transform.scale}}customElements.define("dwg-canvas-board",It);var kt=i(161),St=i(7091),zt=i.n(St),Mt=new URL(i(6299),i.b);const Et='<div id="wrapper"> <canvas id="canvas"></canvas> <button id="close-button" class="set-size"> <img id="close-button-img" class="max-size" src="'+zt()(Mt)+'" draggable="false"> </button> </div> ';var Pt=i(2506),Nt={};Nt.styleTagTransform=ft(),Nt.setAttributes=ut(),Nt.insert=dt().bind(null,"head"),Nt.domAPI=ct(),Nt.insertStyleElement=yt(),nt()(Pt.Z,Nt),Pt.Z&&Pt.Z.locals&&Pt.Z.locals;class Tt extends kt.a{constructor(){super(),this.draw_interval=void 0,this.mouse={x:0,y:0},this.hovered_zone=void 0,this.hovered_space=void 0,this.hovered=!1,this.icons=new Map,this.configureElement("wrapper"),this.configureElement("canvas"),this.configureElement("close_button");for(const t of["unit","building","unit_white","building_white"])this.createIcon(t)}createIcon(t){const e=document.createElement("img");e.src=`/images/icons/${t}64.png`,e.draggable=!1,e.alt=t,this.icons.set(t,e)}getHTML(){return Et}closeDialog(){this.draw_interval&&clearInterval(this.draw_interval),document.body.removeEventListener("keyup",this.keyup.bind(this)),super.closeDialog()}getData(){return this.data}setData(t,e){if(t&&(this.data=t),!e&&!this.fully_parsed)return;if(!this.canvas.getContext)return void console.error("Browser does not support canvas; cannot draw board");for(const t of this.data.space.zones)for(const e of t)e.hovered=!1,e.clicked=!1;const i=.9;.7794*window.innerWidth>i*window.innerHeight?this.size={x:i*window.innerHeight/.866,y:i*window.innerHeight}:this.size={x:i*window.innerWidth,y:i*window.innerWidth*.866},this.radius=.37*this.size.x,this.ctx=this.canvas.getContext("2d"),this.canvas.style.setProperty("--w",`${this.size.x.toString()}px`),this.canvas.style.setProperty("--h",`${this.size.y.toString()}px`),this.canvas.width=this.size.x,this.canvas.height=this.size.y,this.wrapper.addEventListener("mousemove",(t=>{this.hovered=!0;const e=this.canvas.getBoundingClientRect();this.mousemove({x:t.clientX-e.left,y:t.clientY-e.top})})),this.wrapper.addEventListener("mousedown",(t=>{t.stopImmediatePropagation(),this.mousedown(t)})),this.wrapper.addEventListener("mouseup",(t=>{t.stopImmediatePropagation(),this.mouseup(t)})),this.wrapper.addEventListener("mouseenter",(()=>{this.hovered=!0})),this.wrapper.addEventListener("mouseleave",(()=>{this.hovered=!1,this.hovered_zone&&(this.unhoverZone(this.hovered_zone),this.hovered_zone=void 0),this.hovered_space&&(this.hovered_space.hovered=!1,this.hovered_space.clicked=!1,this.hovered_space=void 0)})),this.addEventListener("contextmenu",(t=>{t.preventDefault()}),!1),document.body.addEventListener("keyup",this.keyup.bind(this)),this.close_button.addEventListener("click",(()=>{this.closeDialog()})),this.draw_interval=setInterval((()=>{this.ctx.resetTransform(),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.size.x,this.size.y),this.draw()}),20)}draw(){var t,e;this.ctx.strokeStyle="rgba(250, 250, 250, 0.9)",this.ctx.fillStyle="rgb(0, 0, 0, 0)",this.ctx.lineWidth=4;const i=_(.5,this.size);this.ctx.translate(i.x,i.y);const s=this.radius,r=.42*s;o(this.ctx,{x:0,y:0},s),this.ctx.fillStyle="rgb(10, 120, 10, 0.8)",this.ctx.lineWidth=2;let a=this.data.space.zones[1][1];this.setZoneFill(a),o(this.ctx,{x:0,y:0},.4*s),this.drawZone(a,r,0,{x:.18*s*Math.cos(1*Math.PI/4),y:.18*s*Math.sin(1*Math.PI/4)},{x:.18*s*Math.cos(3*Math.PI/4),y:.18*s*Math.sin(3*Math.PI/4)},{x:.18*s*Math.cos(5*Math.PI/4),y:.18*s*Math.sin(5*Math.PI/4)},{x:.18*s*Math.cos(7*Math.PI/4),y:.18*s*Math.sin(7*Math.PI/4)}),this.ctx.lineWidth=4;const n=Math.PI/3;for(var h=0;h<6;h++){let i={x:0,y:0};switch(h){case 0:i={x:2,y:1};break;case 1:i={x:2,y:0};break;case 2:i={x:1,y:0};break;case 3:i={x:0,y:0};break;case 4:i={x:0,y:1};break;case 5:i={x:1,y:2}}a=this.data.space.zones[i.x][i.y],this.setZoneFill(a),this.ctx.beginPath(),this.ctx.lineTo(.4*s*Math.cos(n*h+Math.PI/6),.4*s*Math.sin(n*h+Math.PI/6)),this.ctx.lineTo(.4*s*Math.cos(n*h+Math.PI/2),.4*s*Math.sin(n*h+Math.PI/2)),this.ctx.lineTo(s*Math.cos(n*h+Math.PI/2),s*Math.sin(n*h+Math.PI/2)),this.ctx.lineTo(s*Math.cos(n*h+Math.PI/6),s*Math.sin(n*h+Math.PI/6)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill();const o=n*(1+h);this.ctx.rotate(o);const c=Math.PI/15;this.drawZone(a,r,o,{x:.76*s*Math.cos(-c),y:.76*s*Math.sin(-c)},{x:.76*s*Math.cos(c),y:.76*s*Math.sin(c)},{x:.53*s*Math.cos(-c),y:.53*s*Math.sin(-c)},{x:.53*s*Math.cos(c),y:.53*s*Math.sin(c)}),this.ctx.rotate(-o),this.ctx.lineWidth=4;const d=G(1,i),_=$(this.data.game.getGame().board_size,l(this.data.space.coordinate,d)),u=W(this.data.game.getGame(),_);this.ctx.strokeStyle="rgba(250, 250, 250, 0.8)";const g=et(u).dAlpha(-.2);if(this.ctx.fillStyle=g.getString(),this.ctx.beginPath(),this.ctx.lineTo(s*Math.cos(n*h+Math.PI/6),s*Math.sin(n*h+Math.PI/6)),this.ctx.lineTo(3*s*Math.cos(n*h+Math.PI/6),3*s*Math.sin(n*h+Math.PI/6)),this.ctx.lineTo(3*s*Math.cos(n*h+Math.PI/2),3*s*Math.sin(n*h+Math.PI/2)),this.ctx.lineTo(s*Math.cos(n*h+Math.PI/2),s*Math.sin(n*h+Math.PI/2)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill(),u&&u.visibility>0){let i=this.icons.get("building"),o=this.icons.get("unit");g.getBrightness()>.5?this.ctx.fillStyle="black":(this.ctx.fillStyle="white",i=this.icons.get("building_white"),o=this.icons.get("unit_white")),this.ctx.textBaseline="top";const r=.27*s,a=.866*r,c=(.866*s+a)*Math.cos(n*h+Math.PI/3),l=(.866*s+a)*Math.sin(n*h+Math.PI/3),d=.25,_=2*a*(1-d),y=r*(1+d),v=y/3-4;this.ctx.font=`bold ${v}px serif`;const f=c-.5*_,x=l-.5*y;this.ctx.drawImage(i,f,x,v,v),this.ctx.fillText(`: ${null===(t=u.buildings)||void 0===t?void 0:t.size.toString()}`,f+v+2,x,_-v-2);const p=l-.5*y+v+2;this.ctx.drawImage(o,f,p,v,v),this.ctx.fillText(`: ${null===(e=u.units)||void 0===e?void 0:e.size.toString()}`,f+v+2,p,_-v-2)}}}mousemove(t){var e,i;let s,o;if(this.mouse=d({x:t.x,y:t.y},_(.5,this.size)),v(this.mouse,.4*this.radius))s=this.data.space.zones[1][1],this.resolveHoveredZone(s,0);else{const t=(0,p.fd)(this.mouse.y,this.mouse.x);let e=Math.floor((t+Math.PI/6)/(Math.PI/3)),i={x:0,y:0};switch(e){case 6:e=0;case 0:i={x:1,y:2};break;case 1:i={x:0,y:1};break;case 2:i={x:0,y:0};break;case 3:i={x:1,y:0};break;case 4:i={x:2,y:0};break;case 5:i={x:2,y:1};break;default:return void console.error("Unknown zone hovered",t)}if(v(this.mouse,this.radius))s=this.data.space.zones[i.x][i.y],this.resolveHoveredZone(s,-Math.PI/3*(6-e));else{const t=G(1,i),e=$(this.data.game.getGame().board_size,l(this.data.space.coordinate,t));o=W(this.data.game.getGame(),e)}}c(null===(e=this.hovered_space)||void 0===e?void 0:e.coordinate,null==o?void 0:o.coordinate)||(this.hovered_space&&(this.hovered_space.clicked=!1,this.hovered_space.hovered=!1),this.hovered_space=o,this.hovered_space&&(this.hovered_space.hovered=!0)),this.hovered_zone&&!c(null===(i=this.hovered_zone)||void 0===i?void 0:i.coordinate,null==s?void 0:s.coordinate)&&(this.unhoverZone(this.hovered_zone),this.hovered_zone=void 0),this.hovered_zone=s}unhoverZone(t){t.clicked=!1,t.hovered=!1;for(const e of t.hovered_data)e.clicked=!1,e.hovered=!1}resolveHoveredZone(t,e){t.hovered=!0;const i=u(this.mouse,e);for(const e of t.hovered_data){const t=i.x-e.c.x,s=i.y-e.c.y;t*t/(e.r.x*e.r.x)+s*s/(e.r.y*e.r.y)<=1?e.hovered=!0:e.hovered=!1}}mousedown(t){if(this.hovered_zone){this.hovered_zone.clicked=!0;for(const t of this.hovered_zone.hovered_data)t.hovered&&(t.clicked=!0)}}mouseup(t){if(this.hovered_zone){this.hovered_zone.clicked=!1;for(const t of this.hovered_zone.hovered_data)t.clicked=!1}}keyup(t){"Escape"===t.key&&this.closeDialog()}setZoneFill(t){this.ctx.strokeStyle="rgba(250, 250, 250, 0.9)";const e=new m(10,120,10,.8);t.hovered&&!t.hovered_data.some((t=>t.hovered))&&(t.clicked?e.addColor(210,210,210,.05):e.addColor(190,190,190,.03)),this.ctx.fillStyle=e.getString()}drawZone(t,e,i,s,o,a,n){function h(t,e,i,s,o,r,a="white"){const n=t.fillStyle;t.fillStyle=a,t.font=`bold ${i}px serif`,t.fillText(e,s,o,r),t.fillStyle=n}this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.lineWidth=1;const c=.5*e;if(4!==t.hovered_data.length){const e={x:.5*c,y:.5*c};t.hovered_data=[{c:s,r:e},{c:o,r:e},{c:a,r:e},{c:n,r:e}]}else t.hovered_data[0].c=s,t.hovered_data[1].c=o,t.hovered_data[2].c=a,t.hovered_data[3].c=n;for(const[e,s]of t.hovered_data.entries()){switch(this.ctx.strokeStyle="transparent",s.hovered?s.clicked?this.ctx.fillStyle="rgba(200, 200, 200, 0.4)":this.ctx.fillStyle="rgba(200, 200, 200, 0.2)":this.ctx.fillStyle="transparent",this.ctx.translate(s.c.x,s.c.y),this.ctx.rotate(-i),e){case 0:t.building?this.ctx.drawImage(this.data.game.getIcon(k(t.building)),-s.r.x,-s.r.y,2*s.r.x,2*s.r.y):this.ctx.strokeStyle="rgba(200, 200, 200, 0.5)";break;case 1:if(1!==t.units_by_type.size)break;const e=[...t.units_by_type.values()][0];if(0===e.size)this.ctx.strokeStyle="rgba(200, 200, 200, 0.5)",h(this.ctx,"0",1.4*s.r.y,-.5*s.r.x,-.7*s.r.y,s.r.x);else if(1===e.size){const i=[...e.values()][0],o=t.units.get([...i.units.values()][0]);this.ctx.drawImage(this.data.game.getIcon(M(o)),-s.r.x,-s.r.y,2*s.r.x,2*s.r.y),h(this.ctx,i.units.size.toString(),1.4*s.r.y,-s.r.x,-.7*s.r.y,2*s.r.x)}else if(2===e.size){const i=[...e.values()];for(let e=0;e<2;e++){const o=[...i[e].units.values()],r=t.units.get(o[0]);this.ctx.drawImage(this.data.game.getIcon(M(r)),(.5*e-1)*s.r.x,(.5*e-1)*s.r.y,1.5*s.r.x,1.5*s.r.y),h(this.ctx,o.length.toString(),s.r.y,(.5*e-1)*s.r.x,(.5*e-1)*s.r.y,2*s.r.x)}}else if(3===e.size){const i=[...e.values()];for(let e=0;e<2;e++){const o=[...i[e].units.values()],r=t.units.get(o[0]);this.ctx.drawImage(this.data.game.getIcon(M(r)),(.8*e-.9)*s.r.x,-.9*s.r.y,s.r.x,s.r.y),h(this.ctx,o.length.toString(),.75*s.r.y,(.8*e-1)*s.r.x,-.9*s.r.y,1.5*s.r.x)}const o=[...i[2].units.values()],r=t.units.get(o[0]);this.ctx.drawImage(this.data.game.getIcon(M(r)),-.5*s.r.x,-.1*s.r.y,s.r.x,s.r.y),h(this.ctx,o.length.toString(),.75*s.r.y,-.5*s.r.x,-.1*s.r.y,1.5*s.r.x)}else if(4===e.size){const i=[...e.values()];for(let e=0;e<2;e++){const o=[...i[e].units.values()],r=t.units.get(o[0]);this.ctx.drawImage(this.data.game.getIcon(M(r)),(.8*e-.9)*s.r.x,-.9*s.r.y,s.r.x,s.r.y),h(this.ctx,o.length.toString(),.75*s.r.y,(.8*e-.9)*s.r.x,-.9*s.r.y,1.5*s.r.x)}for(let e=0;e<2;e++){const o=[...i[2+e].units.values()],r=t.units.get(o[0]);this.ctx.drawImage(this.data.game.getIcon(M(r)),(.8*e-.9)*s.r.x,-.1*s.r.y,s.r.x,s.r.y),h(this.ctx,o.length.toString(),.75*s.r.y,(.8*e-.9)*s.r.x,-.1*s.r.y,1.5*s.r.x)}}else{const i=[...e.values()];for(let e=0;e<2;e++){const o=[...i[e].units.values()],r=t.units.get(o[0]);this.ctx.drawImage(this.data.game.getIcon(M(r)),(.8*e-.9)*s.r.x,-.9*s.r.y,s.r.x,s.r.y)}for(let e=0;e<1;e++){const o=[...i[2+e].units.values()],r=t.units.get(o[0]);this.ctx.drawImage(this.data.game.getIcon(M(r)),(.8*e-.9)*s.r.x,-.1*s.r.y,s.r.x,s.r.y)}h(this.ctx,"...",.8*s.r.y,.1*s.r.x,-.1*s.r.y,s.r.x,"rgba(150, 150, 150, 0.8)"),h(this.ctx,t.units.size.toString(),1.4*s.r.y,-s.r.x,-.7*s.r.y,2*s.r.x)}break;case 2:case 3:this.ctx.strokeStyle="rgba(200, 200, 200, 0.2)",this.ctx.fillStyle="transparent";break;default:console.error("No implemented")}this.ctx.rotate(i),this.ctx.translate(-s.c.x,-s.c.y),r(this.ctx,s.c,s.r)}}}customElements.define("dwg-space-dialog",Tt);var Lt=function(t,e,i,s){return new(i||(i=Promise))((function(o,r){function a(t){try{h(s.next(t))}catch(t){r(t)}}function n(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,n)}h((s=s.apply(t,e||[])).next())}))};class Ot extends s.r{constructor(){super(),this.hex_r=60,this.hex_a=51.96,this.canvas_center={x:0,y:0},this.last_transform={view:{x:0,y:0},scale:1},this.canvas_size=DOMRect.fromRect(),this.mouse_canvas={x:0,y:0},this.mouse_coordinate={x:0,y:0},this.icons=new Map,this.last_time=Date.now(),this.draw_detail=R.SPACE_DETAILS,this.left_panel=new rt(this,{w:300,background:"rgb(222,184,135)"}),this.right_panel=new J(this,{w:300,is_open:!0,background:"rgb(222,184,135)"}),this.board_resize_lock=(0,x.YH)(),this.htmlString=' <dwg-canvas-board id="board"></dwg-canvas-board> ',this.configureElement("board")}createIcon(t){if(this.icons.has(t))return;const e=document.createElement("img");e.src=`/images/${t}.png`,e.draggable=!1,e.alt=t,this.icons.set(t,e)}getIcon(t){return this.icons.has(t)||this.createIcon(t),this.icons.get(t)}initialize(t,e){return Lt(this,void 0,void 0,(function*(){this.player_id=t.isPlayer()?t.playerId():-1,t.setPadding("0px"),this.setNewGameData(e);const i={x:1.732*this.hex_r*(2*e.board_size+1),y:1.5*this.hex_r*(2*e.board_size+1)+.5*this.hex_r};this.board.initialize({board_size:i,max_scale:1,fill_space:!0,allow_side_move:!1,draw:this.draw.bind(this),mousemove:this.mousemove.bind(this),mouseleave:this.mouseleave.bind(this),mousedown:this.mousedown.bind(this),mouseup:this.mouseup.bind(this),zoom_config:{zoom_constant:650,max_zoom:1.3,min_zoom:.7}}).then((e=>{this.boardResize(e.board_size,e.el_size),t.isPlayer()?this.goToVillageCenter(this.player_id):this.goToVillageCenter(0),this.board.addEventListener("canvas_resize",(t=>{this.boardResize(t.detail.board_size,t.detail.el_size)}))}))}))}getGame(){return this.game}getPlayer(){return this.player_id>-1?this.game.players[this.player_id]:void 0}goToVillageCenter(t){var e;if(!(t<0))for(const i of this.game.players[t].buildings.values()){if(1!==i.building_id)continue;const t=this.coordinateToCanvas(i.space_coordinate,null!==(e=this.last_transform.scale)&&void 0!==e?e:1);return void this.board.setView(d(t,this.canvas_center))}}boardResize(t,e){this.board_resize_lock((()=>Lt(this,void 0,void 0,(function*(){var i,s,o;const r=.5*Math.min(t.x,e.width)/this.canvas_center.x;this.canvas_center={x:.5*Math.min(t.x,e.width),y:.5*Math.min(t.y,e.height)},this.canvas_size=e,this.hex_r=t.x/(1.732*(2*this.game.board_size+1)),this.hex_a=.866*this.hex_r,this.board.setMaxScale(.45*e.height/this.hex_r),this.board.scaleView(r);for(const t of null!==(s=null===(i=this.game)||void 0===i?void 0:i.spaces)&&void 0!==s?s:[])for(const e of t)for(const t of null!==(o=e.zones)&&void 0!==o?o:[])for(const e of t)e.reset_hovered_data=!0;this.left_panel.resolveSize(),this.toggleRightPanel(this.right_panel.isOpen())}))))}canvasSize(){return this.canvas_size}toggleRightPanel(t){this.right_panel.toggle(t)}closeLeftPanel(){this.left_panel.close()}gameUpdate(t){return Lt(this,void 0,void 0,(function*(){try{if("start-turn"===t.kind){const e=t.update;yield this.applyStartTurn(e)}else console.log(`Unknown game update type ${t.kind}`)}catch(e){console.log(`Error during game update ${JSON.stringify(t)}: ${e}`)}}))}setNewGameData(t){this.game=function(t){if(!t)return;const e=[];for(const i of t.spaces){const t=[];for(const e of i)t.push(D(e));e.push(t)}const i=t.players.map((t=>function(t){if(!t)return;let e=t.color.split(",").map((t=>parseInt(t.trim())));return 3!==e.length&&(console.error("Error parsing player color",t.color),e=[0,0,0]),{player:t.player,resources:(i=t.resources,new Map([[L.FOOD,i.food],[L.WOOD,i.wood],[L.STONE,i.stone]])),buildings:new Map(t.buildings.map((t=>[t.internal_id,H(t)]))),units:new Map(t.units.map((t=>[t.internal_id,q(t)]))),population_limit:t.population_limit,score:t.score,color:new m(e[0],e[1],e[2])};var i}(t))),s=[];for(const t of i)s.push({player_id:t.player.player_id,nickname:t.player.nickname,score:t.score,color:t.color});return{game_base:t.game_base,players:i,scores:s.sort(((t,e)=>t.score-e.score)),board_size:t.board_size,population_limit:t.population_limit,turn_number:t.turn_number,spaces:e}}(t)}applyStartTurn(t){return Lt(this,void 0,void 0,(function*(){this.setNewGameData(t.game)}))}draw(t,e){const i=Date.now(),s=i-this.last_time;this.last_time=i,this.last_transform=e;const o=2*this.hex_a*.75,r=1.25*this.hex_r,a=r/3-4;this.draw_detail=this.getDrawDetail(e.scale);const n={hex_r:this.hex_r,inset_w:o,inset_h:r,inset_row:a,draw_detail:this.draw_detail};for(const i of this.game.spaces)for(const s of i)s.center=this.coordinateToCanvas(s.coordinate,e.scale),s.center.x+this.hex_a<e.view.x/e.scale||s.center.x-this.hex_a>(e.view.x+this.canvas_size.width)/e.scale||s.center.y+this.hex_r<e.view.y/e.scale||s.center.y-this.hex_r>(e.view.y+this.canvas_size.height)/e.scale||tt(t,this,s,n);this.right_panel.draw(t,e,s),this.left_panel.draw(t,e,s)}getDrawDetail(t){const e=this.board.getMaxScale();return t>.6*(e-1)+1?R.ZONE_DETAILS:t<1/(.2*(e-1)+1)?R.OWNERSHIP:R.SPACE_DETAILS}mousemove(t,e){var i;this.draw_detail=this.getDrawDetail(e.scale),this.mouse_canvas=t;const s=[this.right_panel.mousemove(t,e),this.left_panel.mousemove(t,e)].some((t=>!!t));this.mouse_coordinate=this.canvasToCoordinate(t,e.scale);const o=$(this.game.board_size,g(this.mouse_coordinate)),r=W(this.game,o);if(s||!r)return this.removeHoveredFlags(),void(this.hovered_space&&(this.hovered_space.clicked=!1,this.hovered_space=void 0,this.hovered_zone&&(T(this.hovered_zone),this.hovered_zone=void 0)));const a=()=>{var e;if(this.draw_detail===R.ZONE_DETAILS){let i=N(t,this.hovered_space,this.hex_r);this.hovered_zone&&!c(null==i?void 0:i.coordinate,null===(e=this.hovered_zone)||void 0===e?void 0:e.coordinate)&&(T(this.hovered_zone),this.hovered_zone=void 0),this.hovered_zone=i}else this.hovered_zone&&(T(this.hovered_zone),this.hovered_zone=void 0)};if(c(r.coordinate,null===(i=this.hovered_space)||void 0===i?void 0:i.coordinate))return this.updateHoveredFlags(),void a.call(this);this.removeHoveredFlags(),this.hovered_space&&(this.hovered_space.clicked=!1,this.hovered_zone&&(T(this.hovered_zone),this.hovered_zone=void 0),a.call(this)),this.hovered_space=r,this.updateHoveredFlags()}mouseleave(){this.hovered_space&&(this.hovered_space.hovered=!1,this.hovered_space.clicked=!1,this.hovered_space=void 0)}mousedown(t){if([this.right_panel.mousedown(t),this.left_panel.mousedown(t)].some((t=>!!t)))return!0;if(0!==t.button)return!1;if(this.hovered_space&&this.hovered_space.visibility>0){if(this.hovered_space.clicked=!0,this.draw_detail!==R.ZONE_DETAILS)return!1;if(this.hovered_zone){this.hovered_space.clicked=!1,this.hovered_zone.clicked=!0;for(const t of this.hovered_zone.hovered_data)if(t.hovered)return t.clicked=!0,this.hovered_zone.clicked=!1,!0}}return!1}mouseup(t){if(this.right_panel.mouseup(t),this.left_panel.mouseup(t),this.hovered_space){if(this.hovered_zone){if(this.hovered_space.visibility>0&&this.draw_detail===R.ZONE_DETAILS){let t=!0;for(const[e,i]of this.hovered_zone.hovered_data.entries())if(i.clicked&&i.hovered){switch(t=!1,e){case 0:this.hovered_zone.resource?this.left_panel.openPanel(st.RESOURCE,this.hovered_space.visibility,this.hovered_zone.resource):this.left_panel.openPanel(st.BUILDING,this.hovered_space.visibility,this.hovered_zone.building);break;case 1:this.left_panel.openPanel(st.ECONOMIC_UNITS,this.hovered_space.visibility,{space:this.hovered_space,units:this.hovered_zone.economic_units_by_type});break;case 2:this.left_panel.openPanel(st.MILITARY_UNITS,this.hovered_space.visibility,{space:this.hovered_space,units:this.hovered_zone.military_units_by_type})}break}t&&this.hovered_zone.clicked&&this.left_panel.openPanel(st.ZONE,this.hovered_space.visibility,{space:this.hovered_space,zone:this.hovered_zone})}this.hovered_zone.clicked=!1;for(const t of this.hovered_zone.hovered_data)t.clicked=!1}else this.hovered_space.clicked&&this.hovered_space.visibility>0&&this.draw_detail!==R.ZONE_DETAILS&&this.left_panel.openPanel(st.SPACE,this.hovered_space.visibility,this.hovered_space);this.hovered_space.clicked=!1}}canvasToCoordinate(t,e){const i=(t.y-.25*this.hex_r-this.canvas_center.y/e)/(1.5*this.hex_r)-this.game.board_size-.5;return{x:(t.x-this.canvas_center.x/e)/(1.732*this.hex_r)-.5*i-this.game.board_size-.5,y:i}}coordinateToCanvas(t,e){return{x:1.732*(t.x+.5*t.y+this.game.board_size+.5)*this.hex_r+this.canvas_center.x/e,y:1.5*(t.y+this.game.board_size+.5)*this.hex_r+.25*this.hex_r+this.canvas_center.y/e}}removeHoveredFlags(){if(this.hovered_space){this.hovered_space.hovered=!1;for(const t of this.getBoardNeighbors(this.hovered_space))t.hovered_neighbor=!1;for(const t of this.getBoardRows(this.hovered_space))t.hovered_row=!1}}updateHoveredFlags(){if(this.hovered_space){this.hovered_space.hovered=!0;for(const t of this.getBoardNeighbors(this.hovered_space))t.hovered_neighbor=!0;for(const t of this.getBoardRows(this.hovered_space))t.hovered_row=!0}}getBoardNeighbors(t){const e=[];for(const i of function(t,e){const i=g(t),s=[];for(const t of y){const o=l(i,t);f(o,e)&&s.push(o)}return s}(t.coordinate,this.game.board_size)){const t=$(this.game.board_size,i),s=W(this.game,t);s&&e.push(s)}return e}getBoardRows(t){const e=[];for(const i of function(t,e){const i=g(t),s=[];for(const t of y){let o=i;for(;o=l(o,t),f(o,e);)s.push(o)}return s}(t.coordinate,this.game.board_size)){const t=$(this.game.board_size,i),s=W(this.game,t);s&&e.push(s)}return e}}customElements.define("dwg-risq",Ot)},6442:(t,e,i)=>{function s(t,e){return(t%e+e)%e}function o(t,e){const i=Math.atan2(t,e);return 0===i?0:i<0?-i:2*Math.PI-i}function r(t,e,i,s=!0){return isNaN(e)||null==e||isNaN(i)||null==i?t:i<e?r(t,i,e):isNaN(t)||null==t?s?e:i:t>i?i:t<e?e:t}i.d(e,{IV:()=>r,fd:()=>o,zW:()=>s})}},t=>{t(t.s=4431)}]);