"use strict";(self.webpackChunkgray_online=self.webpackChunkgray_online||[]).push([[700],{3217:(t,e,i)=>{i.d(e,{Z:()=>a});var s=i(8081),r=i.n(s),o=i(3645),n=i.n(o)()(r());n.push([t.id,"dwg-risq #board{height:100%;overflow:hidden;width:100%}",""]);const a=n},2506:(t,e,i)=>{i.d(e,{Z:()=>a});var s=i(8081),r=i.n(s),o=i(3645),n=i.n(o)()(r());n.push([t.id,"dwg-space-dialog #wrapper{align-items:center;display:flex;flex-flow:column nowrap;height:var(--h);gap:1em;padding:0 !important;width:var(--w)}dwg-space-dialog #wrapper>#close-button{--size: 36px;right:0;margin:0;padding:4px;position:absolute;top:calc(-1*var(--size))}",""]);const a=n},5254:(t,e,i)=>{i.d(e,{Z:()=>a});var s=i(8081),r=i.n(s),o=i(3645),n=i.n(o)()(r());n.push([t.id,"dwg-canvas-board{background-color:#000;border:1px solid #fff;box-sizing:border-box;cursor:none;display:block;overflow:hidden}dwg-canvas-board #canvas{--h: 0px;--w: 0px;height:var(--h);position:relative;width:var(--w)}dwg-canvas-board #cursor{--x: -120px;--y: -120px;left:var(--x);position:absolute;top:var(--y);user-select:none;z-index:2}dwg-canvas-board #cursor.hide{display:none}",""]);const a=n},4431:(t,e,i)=>{var s=i(4268);function r(t,e,i,s=Math.PI/6){!function(t,e,i,s,r=0){e<3&&console.error("n must be 3+");const o=2*Math.PI/e;t.beginPath();for(var n=0;n<e;n++)t.lineTo(i.x+s*Math.cos(o*n+r),i.y+s*Math.sin(o*n+r));t.closePath(),t.stroke(),t.fill()}(t,6,e,i,s)}function o(t,e,i){t.beginPath(),t.ellipse(e.x,e.y,i.x,i.y,0,0,2*Math.PI),t.closePath(),t.stroke(),t.fill()}function n(t,e,i,s,r=0){t.beginPath(),t.roundRect(e.x,e.y,i,s,r),t.closePath(),t.stroke(),t.fill()}function a(t,e,i){t.beginPath(),t.lineTo(e.x,e.y),t.lineTo(i.x,i.y),t.stroke()}function h(t,e,i){var s,r,o;t.beginPath(),t.font&&(t.font=i.font),t.textAlign=null!==(s=i.align)&&void 0!==s?s:"left",t.textBaseline=null!==(r=i.baseline)&&void 0!==r?r:"top",t.direction=null!==(o=i.direction)&&void 0!==o?o:"ltr",i.fill_style&&(t.fillStyle=i.fill_style,t.fillText(e,i.p.x,i.p.y,i.w)),i.stroke_style&&(t.strokeStyle=i.stroke_style,t.lineWidth=i.stroke_width,t.strokeText(e,i.p.x,i.p.y,i.w))}function c(t,e){return!t&&!e||!(!t||!e)&&t.x===e.x&&t.y===e.y}function l(t,e){return{x:t.x+e.x,y:t.y+e.y}}function d(t,e){return{x:t.x-e.x,y:t.y-e.y}}function _(t,e){return{x:t*e.x,y:t*e.y}}function u(t,e){return{x:t.x*Math.cos(e)-t.y*Math.sin(e),y:t.x*Math.sin(e)+t.y*Math.cos(e)}}function g(t){let e=Math.round(t.x),i=Math.round(t.y),s=Math.round(-t.x-t.y);const r=Math.abs(e-t.x),o=Math.abs(i-t.y),n=Math.abs(s+t.x+t.y);return r>o&&r>n?e=-i-s:o>n?i=-e-s:s=-e-i,{x:e,y:i}}const y=[{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1}];function v(t,e){const i=.866*e,s=Math.abs(t.x),r=Math.abs(t.y);return!(s>i||r>e)&&e*i-.5*e*s-i*r>=0}function x(t,e){return!(Math.abs(t.x)>e||Math.abs(t.y)>e||Math.abs(t.x+t.y)>e)}var f,p,m,w=i(7483),b=i(6442);class k{constructor(t,e,i,s){this.data={r:0,g:0,b:0,a:0},this.setColor(t,e,i,s)}setColor(t,e,i,s){this.data=this.cleanInput(t,e,i,s)}getString(){return`rgb(${this.data.r}, ${this.data.g}, ${this.data.b}, ${this.data.a})`}addColor(t,e,i,s){const r=this.cleanInput(t,e,i,s),o=this.data.a+r.a;if(0===o)return void(this.data.a=0);const n=(this.data.a*this.data.r+r.a*r.r)/o,a=(this.data.a*this.data.g+r.a*r.g)/o,h=(this.data.a*this.data.b+r.a*r.b)/o;return this.data=this.cleanInput(n,a,h,o),this}dAlpha(t){return this.data.a+=t,this.cleanData(),this}getBrightness(){return(this.data.r+this.data.g+this.data.b)/765}cleanInput(t,e,i,s){return{r:t=(0,b.IV)(t,0,255),g:e=(0,b.IV)(e,0,255),b:i=(0,b.IV)(i,0,255),a:s=(0,b.IV)(s,0,1,!1)}}cleanData(){this.data=this.cleanInput(this.data.r,this.data.g,this.data.b,this.data.a)}}function I(t){if(!t)return;const e=[];for(const i of t.spaces){const t=[];for(const e of i)t.push(M(e));e.push(t)}return{game_base:t.game_base,players:t.players.map((t=>function(t){if(!t)return;let e=t.color.split(",").map((t=>parseInt(t.trim())));return 3!==e.length&&(console.error("Error parsing player color",t.color),e=[0,0,0]),{player:t.player,resources:t.resources,buildings:new Map(t.buildings.map((t=>[t.internal_id,S(t)]))),units:new Map(t.units.map((t=>[t.internal_id,E(t)]))),population_limit:t.population_limit,color:new k(e[0],e[1],e[2])}}(t))),board_size:t.board_size,population_limit:t.population_limit,turn_number:t.turn_number,spaces:e}}function M(t){if(!t)return;const e={coordinate:t.coordinate,visibility:t.visibility,num_military_units:0,num_villager_units:0,center:{x:0,y:0},hovered:!1,hovered_neighbor:!1,hovered_row:!1,clicked:!1};if(t.zones){const i=[];for(const e of t.zones){const t=[];for(const i of e)t.push(z(i));i.push(t)}e.zones=i}return t.resources&&(e.resources=new Map(t.resources.map((t=>[t.internal_id,P(t)])))),t.buildings&&(e.buildings=new Map(t.buildings.map((t=>[t.internal_id,S(t)])))),t.units&&(e.units=new Map(t.units.map((t=>[t.internal_id,E(t)]))),e.num_military_units=[...e.units.values()].filter((t=>t.unit_id>10)).length,e.num_villager_units=[...e.units.values()].filter((t=>t.unit_id<11)).length),e}function z(t){if(t)return{coordinate:t.coordinate,resource:P(t.resource),building:S(t.building),units:new Map(t.units.map((t=>[t.internal_id,E(t)]))),hovered:!1,clicked:!1,hovered_data:[]}}function S(t){if(t)return t}function P(t){if(t)return t}function E(t){if(t)return t}function T(t,e){if(e.x<0||e.x>=t.spaces.length)return;const i=t.spaces[e.x];if(i){if(!(e.y<0||e.y>=i.length))return i[e.y]}else console.log(t.spaces,e.x)}function N(t,e){return{x:e.y+t,y:e.x-Math.max(-t,-(t+e.y))}}function C(t,e){const i=e.x-t;return{x:e.y+Math.max(-t,-(t+i)),y:i}}function L(t,e,i,s,r,o){var n,a,h,c,l,d,_,u,g,y,v,x;r?s?(t.fillStyle=null!==(n=i.click_fill_style)&&void 0!==n?n:null!==(a=i.hover_fill_style)&&void 0!==a?a:i.fill_style,t.strokeStyle=null!==(h=i.click_stroke_style)&&void 0!==h?h:null!==(c=i.hover_stroke_style)&&void 0!==c?c:i.stroke_style,t.lineWidth=null!==(l=i.click_stroke_width)&&void 0!==l?l:null!==(d=i.hover_stroke_width)&&void 0!==d?d:i.stroke_width):i.draw_clicked_when_unhovered?(t.fillStyle=null!==(_=i.click_fill_style)&&void 0!==_?_:i.fill_style,t.strokeStyle=null!==(u=i.click_stroke_style)&&void 0!==u?u:i.stroke_style,t.lineWidth=null!==(g=i.click_stroke_width)&&void 0!==g?g:i.stroke_width):(t.fillStyle=i.fill_style,t.strokeStyle=i.stroke_style,t.lineWidth=i.stroke_width):s?(t.fillStyle=null!==(y=i.hover_fill_style)&&void 0!==y?y:i.fill_style,t.strokeStyle=null!==(v=i.hover_stroke_style)&&void 0!==v?v:i.stroke_style,t.lineWidth=null!==(x=i.hover_stroke_width)&&void 0!==x?x:i.stroke_width):(t.fillStyle=i.fill_style,t.strokeStyle=i.stroke_style,t.lineWidth=i.stroke_width),i.fixed_position&&(t.scale(1/e.scale,1/e.scale),t.translate(e.view.x,e.view.y)),t.beginPath(),o(),i.fixed_position&&(t.translate(-e.view.x,-e.view.y),t.scale(e.scale,e.scale))}function R(t){switch(t.button){case 0:return p.LEFT_MOUSE;case 1:return p.MIDDLE_MOUSE;case 2:return p.RIGHT_MOUSE;default:return p.UNKNOWN}}!function(t){t[t.NONE=0]="NONE",t[t.BLUNT=1]="BLUNT",t[t.PIERCING=2]="PIERCING",t[t.MAGIC=3]="MAGIC",t[t.BLUNT_PIERCING=4]="BLUNT_PIERCING",t[t.PIERCING_MAGIC=5]="PIERCING_MAGIC",t[t.MAGIC_BLUNT=6]="MAGIC_BLUNT",t[t.BLUNT_PIERCING_MAGIC=7]="BLUNT_PIERCING_MAGIC"}(f||(f={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.LEFT_MOUSE=1]="LEFT_MOUSE",t[t.RIGHT_MOUSE=2]="RIGHT_MOUSE",t[t.MIDDLE_MOUSE=3]="MIDDLE_MOUSE",t[t.ENTER_KEY=4]="ENTER_KEY",t[t.HOLD_CLICK=5]="HOLD_CLICK"}(p||(p={}));class D{constructor(t){this.hovering=!1,this.clicking=!1,this.click_hold_timer=0,this.hold_clicks=0,t.hold_click&&(t.hold_click_time<1?(t.hold_click=!1,console.error("Must set hold click time for hold click buttons")):t.hold_click_delay<1&&(t.hold_click_delay=t.hold_click_time)),this.config=t}isHovering(){return this.hovering}setHovering(t){this.hovering=t}isClicking(){return this.clicking}setClicking(t){this.clicking=t}draw(t,e,i){this.clicking&&this.config.hold_click&&(this.click_hold_timer-=i,this.click_hold_timer<0&&(this.click_hold_timer+=this.config.hold_click_time,this.hold_clicks++,this.clicked(p.HOLD_CLICK))),this._draw(t,e,i)}mousemove(t,e){const i=this.hovering;return this.hovering=this.mouseOver(t,e),!i&&this.hovering?this.hovered():i&&!this.hovering&&this.unhovered(),this.hovering}mousedown(t){const e=R(t);return!(e===p.UNKNOWN||this.config.only_left_click&&e!==p.LEFT_MOUSE||!this.hovering||this.clicking||(this.clicking=!0,this.click_hold_timer=this.config.hold_click_delay,this.hold_clicks=0,this.clicked(e),0))}mouseup(t){const e=R(t);e!==p.UNKNOWN&&this.clicking&&(this.clicking=!1,this.released(e))}}class A extends D{constructor(t){var e,i,s;super(t.button_config),this.reached_target={x:!1,y:!1},t.move_animation_speed=null!==(e=t.move_animation_speed)&&void 0!==e?e:0,t.rotate_animation_speed=null!==(i=t.rotate_animation_speed)&&void 0!==i?i:0,t.image_path&&(this.img=document.createElement("img"),this.img.src=`/images/${t.image_path}.png`,this.img.draggable=!1),t.rotation=null!==(s=t.rotation)&&void 0!==s?s:0,this.rect_config=t,this.refreshPositionDependencies()}setPosition(t,e,i=!1){this.rect_config.move_animation_speed>0&&!c(t,this.rect_config.p)&&!i?(this.target_p=t,this.speed_p={x:(t.x-this.rect_config.p.x)/this.rect_config.move_animation_speed,y:(t.y-this.rect_config.p.y)/this.rect_config.move_animation_speed},this.reached_target={x:!1,y:!1},this.target_callback=e):(this.rect_config.p=t,this.refreshPositionDependencies(),e&&e())}setRotation(t,e,i=!1){if(this.rect_config.rotate_animation_speed>0&&t.angle!==this.rect_config.rotation&&!i){this.rotate_target=t;const i=(t.angle-this.rect_config.rotation)%(2*Math.PI);this.rotate_speed=i/this.rect_config.rotate_animation_speed,this.rotate_reached=!1,this.rotate_callback=e}else this.rect_config.rotation=t.angle,e&&e()}refreshPositionDependencies(){this.radius_p={x:.5*this.rect_config.w,y:.5*this.rect_config.h},this.center_p=l(this.rect_config.p,this.radius_p)}xi(){return this.rect_config.p.x}yi(){return this.rect_config.p.y}xf(){return this.rect_config.p.x+this.rect_config.w}yf(){return this.rect_config.p.y+this.rect_config.h}xc(){return this.center_p.x}yc(){return this.center_p.y}w(){return this.rect_config.w}h(){return this.rect_config.h}_draw(t,e,i){if(this.target_p&&this.speed_p){if(this.reached_target.x&&this.reached_target.y)this.rect_config.p=Object.assign({},this.target_p),this.target_p=void 0,this.speed_p=void 0,this.target_callback&&this.target_callback();else{if(!this.reached_target.x){const t=this.speed_p.x*i;Math.abs(this.rect_config.p.x-this.target_p.x)<=Math.abs(t)?(this.reached_target.x=!0,this.rect_config.p.x=this.target_p.x):(this.rect_config.p.x+=t,Math.abs(this.rect_config.p.x-this.target_p.x)<=Math.abs(t)&&(this.reached_target.x=!0))}if(!this.reached_target.y){const t=this.speed_p.y*i;Math.abs(this.rect_config.p.y-this.target_p.y)<=Math.abs(t)?(this.reached_target.y=!0,this.rect_config.p.y=this.target_p.y):(this.rect_config.p.y+=t,Math.abs(this.rect_config.p.y-this.target_p.y)<=Math.abs(t)&&(this.reached_target.y=!0))}}this.refreshPositionDependencies()}if(this.rotate_target&&this.rotate_speed){const t=this.rotate_speed*i;this.rotate_reached||Math.abs(this.rect_config.rotation-this.rotate_target.angle)<=Math.abs(t)?(this.rect_config.rotation=this.rotate_target.angle,this.rotate_target=void 0,this.rotate_speed=void 0):(this.rect_config.rotation+=t,Math.abs(this.rect_config.rotation-this.rotate_target.angle)<=Math.abs(t)&&(this.rotate_reached=!0))}L(t,e,this.rect_config.draw_config,this.isHovering(),this.isClicking(),(()=>{t.beginPath(),t.translate(this.center_p.x,this.center_p.y),t.rotate(this.rect_config.rotation),this.img&&t.drawImage(this.img,-this.radius_p.x,-this.radius_p.y,this.rect_config.w,this.rect_config.h),n(t,_(-1,this.radius_p),this.rect_config.w,this.rect_config.h),t.rotate(-this.rect_config.rotation),t.translate(-this.center_p.x,-this.center_p.y)}))}mouseOver(t,e){return this.rect_config.draw_config.fixed_position&&(t={x:t.x*e.scale-e.view.x,y:t.y*e.scale-e.view.y}),!(t.x<this.xi()||t.y<this.yi()||t.x>this.xf()||t.y>this.yf())}}class O extends A{constructor(t){super(Object.assign(Object.assign({},t),{w:t.s,h:t.s}))}}class U extends O{constructor(t){super({button_config:{only_left_click:!0},p:{x:0,y:0},s:36,draw_config:{fill_style:"transparent",stroke_style:"transparent",stroke_width:0,hover_fill_style:"rgb(180, 180, 180, 0.5)",click_fill_style:"rgb(210, 210, 210, 0.7)",fixed_position:!0},move_animation_speed:200,rotate_animation_speed:400,image_path:"icons/triangle_gray36",rotation:-.5*Math.PI}),this.risq=t}hovered(){}unhovered(){}clicked(){}released(){this.isHovering()&&(this.risq.toggleRightPanel(),this.setHovering(!1))}}class B{constructor(t,e){this.opening=!1,this.hovering=!1,this.risq=t,this.config=e,this.open_button=new U(t),this.toggle(e.is_open,!0)}isHovering(){return this.hovering}isClicking(){return!1}isOpen(){return this.config.is_open}toggle(t,e){this.config.is_open=null!=t?t:!this.config.is_open;const i={x:this.risq.canvasSize().width-this.open_button.w(),y:.5*this.open_button.h()};this.config.is_open&&(i.x-=this.config.w),this.opening=!0,this.open_button.setPosition(i,(()=>{this.opening=!1;const t={direction:this.config.is_open,angle:this.config.is_open?.5*Math.PI:-.5*Math.PI};this.open_button.setRotation(t,void 0,e)}),e)}draw(t,e,i){(this.opening||this.config.is_open)&&L(t,e,{fill_style:this.config.background,stroke_style:"transparent",stroke_width:0,fixed_position:!0},!1,!1,(()=>{if(n(t,{x:this.xi(),y:this.yi()},this.w(),this.h()),!this.opening&&this.config.is_open){h(t,`Turn ${this.risq.getGame().turn_number}`,{p:{x:this.xc(),y:this.yi()},w:this.w(),fill_style:"black",align:"center",font:"bold 36px serif"});let e=this.yi()+40;const i=this.risq.getPlayer();if(this.drawSeparator(t,e),e+=5,i){let s;for(s in t.font="24px serif",this.drawPopulation(t,e,i.units.size,i.population_limit),e+=30,i.resources)i&&this.drawResource(t,e,s,i.resources[s]),e+=30;e+=5,this.drawSeparator(t,e),e+=5}}})),this.open_button.draw(t,e,i)}drawSeparator(t,e){t.strokeStyle="rgba(60, 60, 60, 0.6)",t.lineWidth=2,a(t,{x:this.xi()+.15*this.w(),y:e},{x:this.xf()-.15*this.w(),y:e})}drawPopulation(t,e,i,s){t.beginPath(),t.drawImage(this.risq.getIcon("icons/person64"),this.xi()+.1*this.w(),e,30,30),h(t,`${i}/${s}`,{p:{x:this.xi()+.1*this.w()+36,y:e+15},w:.9*this.w()-36,fill_style:"black",baseline:"middle"})}drawResource(t,e,i,s){t.beginPath(),t.drawImage(this.risq.getIcon(`risq/resources/${i}`),this.xi()+.1*this.w(),e,30,30),h(t,s.toString(),{p:{x:this.xi()+.1*this.w()+36,y:e+15},w:.9*this.w()-36,fill_style:"black",baseline:"middle"})}mousemove(t,e){return!!this.open_button.mousemove(t,e)||((t={x:t.x*e.scale-e.view.x,y:t.y*e.scale-e.view.y}).x>this.xi()&&t.y>this.yi()&&t.x<this.xf()&&t.y<this.yf()?this.hovering=!0:this.hovering=!1,this.isHovering())}mousedown(t){return!!this.open_button.mousedown(t)||this.isHovering()}mouseup(t){this.open_button.mouseup(t)}xi(){return this.open_button.xf()}yi(){return 0}xf(){return this.risq.canvasSize().width}yf(){return this.risq.canvasSize().height}xc(){return this.xi()+.5*this.w()}yc(){return this.yi()+.5*this.h()}w(){return this.xf()-this.xi()}h(){return this.yf()-this.yi()}}function $(t){let e="empty_plot";if(t)switch(t.building_id){case 1:e="village_center";break;case 2:e="housing";break;default:return console.error("Trying to get building image from unknown building id",t.building_id),""}return`risq/buildings/${e}`}function H(t){let e="error";if(t)switch(t.resource_id){case 1:e="forage_bush";break;case 2:e="deer";break;case 11:e="tree_cedar";break;case 12:e="tree_dead";break;case 13:e="tree_maple";break;case 14:e="tree_oak";break;case 15:e="tree_pine";break;case 16:e="tree_walnut";break;case 21:e="stonemine";break;case 31:e="goldmine";break;default:return console.error("Trying to get resource image from unknown resource id",t.resource_id),""}return`risq/resources/${e}`}function Z(t){let e="";switch(t.unit_id){case 1:e="villager";break;case 11:e="swordsman";break;default:return console.error("Trying to get unit image from unknown unit id",t.unit_id),new Image}const i=new Image;return i.src=`/images/risq/units/${e}.png`,i.alt=e.split("_").map((t=>(0,w.kC)(t))).join(" "),i}function G(t){t.units_by_type=new Map;for(const e of t.units.values())t.units_by_type.has(e.unit_id)?t.units_by_type.get(e.unit_id).units.add(e.internal_id):t.units_by_type.set(e.unit_id,{unit_id:e.unit_id,units:new Set([e.internal_id])})}function W(t,e){t.strokeStyle="rgba(250, 250, 250, 0.9)";const i=new k(10,120,10,.8);e.hovered&&!e.hovered_data.some((t=>t.hovered))&&(e.clicked?i.addColor(210,210,210,.06):i.addColor(190,190,190,.03)),t.fillStyle=i.getString()}function q(t,e,i,s,r,n,a,h,c){const l=s?"rgb(0, 0, 0)":"rgb(255, 255, 255)",d=s?"rgba(40, 40, 40, 0.4)":"rgba(210, 210, 210, 0.4)",_=s?"rgb(60, 60, 60, 0.2)":"rgba(190, 190, 190, 0.2)";function u(t,e,i,s,r,o,n=!0){const a=t.fillStyle;t.fillStyle=n?l:d,t.font=`bold ${i}px serif`,t.fillText(e,s,r,o),t.fillStyle=a}t.textAlign="left",t.textBaseline="top";const g=.5*r;if(3!==i.hovered_data.length||i.reset_hovered_data){const t={x:.5*g,y:.5*g};i.hovered_data=[{c:a,r:t},{c:h,r:t},{c,r:t}],i.reset_hovered_data=!1}else i.hovered_data[0].c=a,i.hovered_data[1].c=h,i.hovered_data[2].c=c;for(const[s,r]of i.hovered_data.entries()){switch(t.strokeStyle="transparent",r.hovered?r.clicked?t.fillStyle=d:t.fillStyle=_:t.fillStyle="transparent",t.translate(r.c.x,r.c.y),t.rotate(-n),s){case 0:i.resource?t.drawImage(e.getIcon(H(i.resource)),-r.r.x,-r.r.y,2*r.r.x,2*r.r.y):t.drawImage(e.getIcon($(i.building)),-r.r.x,-r.r.y,2*r.r.x,2*r.r.y);break;case 1:case 2:i.units_by_type||G(i);const o=[...i.units_by_type.values()],n=1===s?o.filter((t=>t.unit_id<11)):o.filter((t=>t.unit_id>10));if(0===n.length)t.strokeStyle=d;else if(1===n.length){const e=i.units.get([...n[0].units.values()][0]);t.drawImage(Z(e),-r.r.x,-r.r.y,2*r.r.x,2*r.r.y),u(t,n[0].units.size.toString(),1.4*r.r.y,-r.r.x,-.7*r.r.y,2*r.r.x)}else if(2===n.length)for(let e=0;e<2;e++){const s=[...n[e].units.values()],o=i.units.get(s[0]);t.drawImage(Z(o),(.5*e-1)*r.r.x,(.5*e-1)*r.r.y,1.5*r.r.x,1.5*r.r.y),u(t,s.length.toString(),r.r.y,(.5*e-1)*r.r.x,(.5*e-1)*r.r.y,2*r.r.x)}else if(3===n.length){for(let e=0;e<2;e++){const s=[...n[e].units.values()],o=i.units.get(s[0]);t.drawImage(Z(o),(.8*e-.9)*r.r.x,-.9*r.r.y,r.r.x,r.r.y),u(t,s.length.toString(),.75*r.r.y,(.8*e-1)*r.r.x,-.9*r.r.y,1.5*r.r.x)}const e=[...n[2].units.values()],s=i.units.get(e[0]);t.drawImage(Z(s),-.5*r.r.x,-.1*r.r.y,r.r.x,r.r.y),u(t,e.length.toString(),.75*r.r.y,-.5*r.r.x,-.1*r.r.y,1.5*r.r.x)}else if(4===n.length){for(let e=0;e<2;e++){const s=[...n[e].units.values()],o=i.units.get(s[0]);t.drawImage(Z(o),(.8*e-.9)*r.r.x,-.9*r.r.y,r.r.x,r.r.y),u(t,s.length.toString(),.75*r.r.y,(.8*e-.9)*r.r.x,-.9*r.r.y,1.5*r.r.x)}for(let e=0;e<2;e++){const s=[...n[2+e].units.values()],o=i.units.get(s[0]);t.drawImage(Z(o),(.8*e-.9)*r.r.x,-.1*r.r.y,r.r.x,r.r.y),u(t,s.length.toString(),.75*r.r.y,(.8*e-.9)*r.r.x,-.1*r.r.y,1.5*r.r.x)}}else{for(let e=0;e<2;e++){const s=[...n[e].units.values()],o=i.units.get(s[0]);t.drawImage(Z(o),(.8*e-.9)*r.r.x,-.9*r.r.y,r.r.x,r.r.y)}for(let e=0;e<1;e++){const s=[...n[2+e].units.values()],o=i.units.get(s[0]);t.drawImage(Z(o),(.8*e-.9)*r.r.x,-.1*r.r.y,r.r.x,r.r.y)}u(t,"...",.8*r.r.y,.1*r.r.x,-.1*r.r.y,r.r.x,!1),u(t,i.units.size.toString(),1.4*r.r.y,-r.r.x,-.7*r.r.y,2*r.r.x)}break;default:console.error("No implemented")}t.rotate(n),t.translate(-r.c.x,-r.c.y),o(t,r.c,r.r)}}function V(t){if(t){t.clicked=!1,t.hovered=!1;for(const e of t.hovered_data)e.clicked=!1,e.hovered=!1}}!function(t){t[t.OWNERSHIP=0]="OWNERSHIP",t[t.SPACE_DETAILS=1]="SPACE_DETAILS",t[t.ZONE_DETAILS=2]="ZONE_DETAILS"}(m||(m={}));const F=new Map([[m.OWNERSHIP,3],[m.SPACE_DETAILS,2],[m.ZONE_DETAILS,1.2]]);function K(t,e,i,s){t.strokeStyle="rgba(250, 250, 250, 0.9)";const o=Y(i);t.fillStyle=o.getString(),t.lineWidth=F.get(s.draw_detail),r(t,i.center,s.hex_r),t.textAlign="left";const n=o.getBrightness()>.5;if(s.draw_detail!==m.OWNERSHIP)if(s.draw_detail===m.SPACE_DETAILS){if(i.visibility<2)return;let r=e.getIcon("icons/building64"),o=e.getIcon("icons/villager64"),a=e.getIcon("icons/unit64");n?t.fillStyle="black":(t.fillStyle="white",r=e.getIcon("icons/building_white64"),o=e.getIcon("icons/villager_white64"),a=e.getIcon("icons/unit_white64")),t.textBaseline="top";const h=i.center.x-.5*s.inset_w,c=i.center.y-.5*s.inset_h;t.drawImage(r,h,c,s.inset_row,s.inset_row),t.fillText(`: ${i.buildings.size.toString()}`,h+s.inset_row+2,c,s.inset_w-s.inset_row-2);const l=i.center.y-.5*s.inset_h+s.inset_row+2;t.drawImage(o,h,l,s.inset_row,s.inset_row),t.fillText(`: ${i.num_villager_units.toString()}`,h+s.inset_row+2,l,s.inset_w-s.inset_row-2);const d=i.center.y-.5*s.inset_h+2*(s.inset_row+2);t.drawImage(a,h,d,s.inset_row,s.inset_row),t.fillText(`: ${i.num_military_units.toString()}`,h+s.inset_row+2,d,s.inset_w-s.inset_row-2)}else if(s.draw_detail===m.ZONE_DETAILS){if(i.visibility<3)return;t.translate(i.center.x,i.center.y),t.fillStyle="rgb(10, 120, 10, 0.8)",t.strokeStyle="rgba(0, 250, 250, 0.2)",t.lineWidth=.1;let o=i.zones[1][1];W(t,o);const h=s.hex_r,c=.4*h;let l=.45*h;r(t,{x:0,y:0},c),q(t,e,o,n,l,0,{x:.18*h*Math.cos(3*Math.PI/6),y:.18*h*Math.sin(3*Math.PI/6)},{x:.18*h*Math.cos(7*Math.PI/6),y:.18*h*Math.sin(7*Math.PI/6)},{x:.18*h*Math.cos(11*Math.PI/6),y:.18*h*Math.sin(11*Math.PI/6)}),l=.43*h;const d=Math.PI/3;for(var a=0;a<6;a++){let s={x:0,y:0};switch(a){case 0:s={x:2,y:1};break;case 1:s={x:2,y:0};break;case 2:s={x:1,y:0};break;case 3:s={x:0,y:0};break;case 4:s={x:0,y:1};break;case 5:s={x:1,y:2}}o=i.zones[s.x][s.y],W(t,o),t.beginPath(),t.lineTo(c*Math.cos(d*a+Math.PI/6),c*Math.sin(d*a+Math.PI/6)),t.lineTo(c*Math.cos(d*a+Math.PI/2),c*Math.sin(d*a+Math.PI/2)),t.lineTo(h*Math.cos(d*a+Math.PI/2),h*Math.sin(d*a+Math.PI/2)),t.lineTo(h*Math.cos(d*a+Math.PI/6),h*Math.sin(d*a+Math.PI/6)),t.closePath(),t.stroke(),t.fill();const r=d*(1+a);t.rotate(r);const _=Math.PI/12;q(t,e,o,n,l,r,{x:.73*h*Math.cos(0),y:.76*h*Math.sin(0)},{x:.53*h*Math.cos(-_),y:.53*h*Math.sin(-_)},{x:.53*h*Math.cos(_),y:.53*h*Math.sin(_)}),t.rotate(-r)}t.translate(-i.center.x,-i.center.y)}}function Y(t){const e=new k(0,0,0,0);return t&&(e.setColor(90,90,90,.8),t.visibility>0?(e.setColor(10,120,10,.8),t.hovered&&(t.clicked?e.addColor(210,210,210,.4):e.addColor(190,190,190,.2))):t.hovered&&e.addColor(150,150,150,.1)),e}class j extends O{constructor(t){super({button_config:{only_left_click:!0},p:{x:0,y:0},s:36,draw_config:{fill_style:"transparent",stroke_style:"transparent",stroke_width:0,hover_fill_style:"rgb(180, 180, 180, 0.5)",click_fill_style:"rgb(210, 210, 210, 0.7)",fixed_position:!0},image_path:"icons/close_gray32"}),this.risq=t}hovered(){}unhovered(){}clicked(){}released(){this.isHovering()&&(this.risq.closeLeftPanel(),this.setHovering(!1))}}var X;!function(t){t[t.RESOURCE=0]="RESOURCE",t[t.BUILDING=1]="BUILDING"}(X||(X={}));class J{constructor(t,e){this.showing=!1,this.hovering=!1,this.risq=t,e.w<1&&(e.w=120),this.config=e,this.close_button=new j(t),this.resolveSize()}resolveSize(){let t=4*this.config.w;t>this.risq.canvasSize().height&&(t=this.risq.canvasSize().height),this.size={x:t/3,y:t},this.close_button.setPosition({x:this.size.x,y:this.yi()+.5*this.close_button.h()})}isHovering(){return this.hovering}isClicking(){return!1}isShowing(){return this.showing}close(){this.showing=!1,this.data_type=void 0,this.visibility=void 0,this.data=void 0}openPanel(t,e,i){e<1||e<3&&[X.RESOURCE,X.BUILDING].includes(t)||(this.data_type=t,this.visibility=e,this.data=i,this.showing=!0)}draw(t,e,i){this.isShowing()&&(L(t,e,{fill_style:this.config.background,stroke_style:"transparent",stroke_width:0,fixed_position:!0},!1,!1,(()=>{switch(n(t,{x:this.xi(),y:this.yi()},this.w(),this.h()),this.data_type){case X.RESOURCE:this.drawResource(t,this.data);break;case X.BUILDING:this.drawBuilding(t,this.data);break;default:console.error("Unknown data type for left panel",this.data_type)}})),t.beginPath(),this.close_button.draw(t,e,i))}drawResource(t,e){let i=this.yi()+this.drawName(t,e.display_name);i+=this.drawImage(t,i,H(e)),this.drawSeparator(t,i),i+=8,t.beginPath(),t.drawImage(this.risq.getIcon(function(t){let e="error";return t.resource_id<11?e="food":t.resource_id<21?e="wood":t.resource_id<31?e="stone":t.resource_id<41&&(e="gold"),`risq/resources/${e}`}(e)),this.xi()+.1*this.w(),i,40,40),h(t,this.visibility<5?"??":e.resources_left.toString(),{p:{x:this.xi()+.1*this.w()+48,y:i+20},w:.9*this.w()-48,fill_style:"black",baseline:"middle",font:"36px serif"}),i+=50,h(t,`Base gather speed: ${e.base_gather_speed}`,{p:{x:this.xi()+.1*this.w(),y:i+12},w:.9*this.w(),fill_style:"black",baseline:"middle",font:"18px serif"})}drawBuilding(t,e){var i;let s=this.yi()+this.drawName(t,null!==(i=null==e?void 0:e.display_name)&&void 0!==i?i:"Empty Plot");if(s+=this.drawImage(t,s,$(e)),this.drawSeparator(t,s),!e)return s+=12,void h(t,"An empty lot that can be built on",{p:{x:this.xi()+.1*this.w(),y:s},w:.9*this.w(),fill_style:"black",align:"left",font:"14px serif"});s=this.yi()+.25*this.size.y+6,this.drawCombatStats(t,s,s+.25*this.size.y-12,e.combat_stats),this.risq.getPlayer().player.player_id===e.player_id&&(this.drawSeparator(t,this.yi()+.5*this.size.y),this.drawSeparator(t,this.yi()+.75*this.size.y))}drawCombatStats(t,e,i,s){if(!(i-e>20))return;const r=1/4*(i-e);e+=4;const o=this.xi()+.1*this.w(),a=Math.min(14,.4*r);t.strokeStyle="black",t.lineWidth=.4,t.fillStyle="black",n(t,{x:o,y:e},.8*this.w(),a),s.max_health>0&&s.health>0&&(t.fillStyle="rgb(100, 250, 100)",n(t,{x:o,y:e},s.health/s.max_health*.8*this.w(),a)),h(t,`${s.health} / ${s.max_health}`,{p:{x:o,y:e+a+.1*r},w:.8*this.w(),fill_style:"black",align:"left",font:`${a}px serif`}),e+=r+4,s.attack_type,f.NONE}drawName(t,e){const i=Math.min(40,1/12*this.size.y);return h(t,e,{p:{x:this.xc(),y:this.yi()},w:this.w(),fill_style:"black",align:"center",font:`bold ${.85*i}px serif`}),i}drawImage(t,e,i){t.beginPath();const s=.25*this.size.y-e+this.yi(),r=Math.min(s-6,.8*this.w());return t.drawImage(this.risq.getIcon(i),.5*(this.w()-r),e,r,r),s}drawSeparator(t,e){t.strokeStyle="rgba(60, 60, 60, 0.7)",t.lineWidth=2,a(t,{x:this.xi()+.1*this.w(),y:e},{x:this.xf()-.1*this.w(),y:e})}mousemove(t,e){return!!this.close_button.mousemove(t,e)||((t={x:t.x*e.scale-e.view.x,y:t.y*e.scale-e.view.y}).x>this.xi()&&t.y>this.yi()&&t.x<this.xf()&&t.y<this.yf()?this.hovering=!0:this.hovering=!1,this.isHovering())}mousedown(t){return!!this.close_button.mousedown(t)}mouseup(t){this.close_button.mouseup(t)}xi(){return 0}yi(){return.5*(this.risq.canvasSize().height-this.size.y)}xf(){return this.showing?this.xi()+this.w():0}yf(){return this.showing?this.yi()+this.h():0}xc(){return this.xi()+.5*this.w()}yc(){return this.yi()+.5*this.h()}w(){return this.size.x}h(){return this.size.y}}var Q=i(3379),tt=i.n(Q),et=i(7795),it=i.n(et),st=i(569),rt=i.n(st),ot=i(3565),nt=i.n(ot),at=i(9216),ht=i.n(at),ct=i(4589),lt=i.n(ct),dt=i(3217),_t={};_t.styleTagTransform=lt(),_t.setAttributes=nt(),_t.insert=rt().bind(null,"head"),_t.domAPI=it(),_t.insertStyleElement=ht(),tt()(dt.Z,_t),dt.Z&&dt.Z.locals&&dt.Z.locals;var ut=i(5254),gt={};gt.styleTagTransform=lt(),gt.setAttributes=nt(),gt.insert=rt().bind(null,"head"),gt.domAPI=it(),gt.insertStyleElement=ht(),tt()(ut.Z,gt),ut.Z&&ut.Z.locals&&ut.Z.locals;var yt=function(t,e,i,s){return new(i||(i=Promise))((function(r,o){function n(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,a)}h((s=s.apply(t,e||[])).next())}))};class vt extends s.r{constructor(){super(),this.transform={scale:1,view:{x:0,y:0}},this.hovered=!1,this.holding_keys={arrow_up:!1,arrow_down:!1,arrow_left:!1,arrow_right:!1},this.cursor_move_threshold=5,this.dragging=!1,this.mouse={x:0,y:0},this.cursor_in_range=!1,this.resize_observer=new ResizeObserver((t=>yt(this,void 0,void 0,(function*(){for(const e of t)yield this.updateSize(this.data,e.contentRect),this.dispatchEvent(new CustomEvent("canvas_resize",{detail:{board_size:this.data.board_size,el_size:this.bounding_rect},bubbles:!0}))})))),this.htmlString=' <canvas id="canvas">Board</canvas> <img id="cursor" alt="cursor" draggable="false"> ',this.configureElement("canvas"),this.configureElement("cursor")}getBoundingRect(){return this.bounding_rect}initialize(t){var e;return yt(this,void 0,void 0,(function*(){if(t.allow_side_move=null===(e=t.allow_side_move)||void 0===e||e,this.orig_size={x:t.board_size.x,y:t.board_size.y},yield this.updateSize(t))return this.cursor.src="/images/cursors/cursor.png",this.addEventListeners(),yield(0,w.C4)((()=>{var t;return!!(null===(t=this.canvas.getBoundingClientRect())||void 0===t?void 0:t.width)})),this.resize_observer.observe(this),setInterval((()=>{this.tick(),this.ctx.resetTransform(),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.data.board_size.x,this.data.board_size.y),this.ctx.translate(-this.transform.view.x,-this.transform.view.y),this.ctx.scale(this.transform.scale,this.transform.scale),this.data.draw(this.ctx,this.transform)}),20),{board_size:this.data.board_size,el_size:this.bounding_rect}}))}updateSize(t,e){return yt(this,void 0,void 0,(function*(){return!t||this.orig_size.x<1||this.orig_size.y<1?(console.error("Size must be at least 1px in each direction"),!1):!t.max_scale||t.max_scale<1?(console.error(`Max scale of ${t.max_scale} is invalid`),!1):(this.data=t,yield(0,w.C4)((()=>this.fully_parsed)),this.canvas.getContext?(yield this.setSize(e),!0):(console.error("Browser does not support canvas; cannot draw board"),!1))}))}setSize(t){return yt(this,void 0,void 0,(function*(){const e=this.data;if(t?this.bounding_rect=t:(yield(0,w.C4)((()=>{var t;return this.bounding_rect=this.getBoundingClientRect(),!!(null===(t=this.bounding_rect)||void 0===t?void 0:t.width)})),t=this.bounding_rect),e.fill_space){const i=this.orig_size.x/this.orig_size.y;e.board_size.x=Math.max(this.orig_size.x,t.width),e.board_size.y=Math.max(this.orig_size.y,t.height),e.board_size.x/e.board_size.y>i?e.board_size.y=e.board_size.x/i:e.board_size.x=e.board_size.y*i}this.ctx=this.canvas.getContext("2d"),this.canvas.style.setProperty("--w",`${e.board_size.x.toString()}px`),this.canvas.style.setProperty("--h",`${e.board_size.y.toString()}px`),this.canvas.width=e.board_size.x,this.canvas.height=e.board_size.y}))}addEventListeners(){this.addEventListener("wheel",(t=>{const e=1+t.deltaY/250;this.setScale(this.transform.scale/e),this.data.mousemove({x:(this.mouse.x+this.transform.view.x)/this.transform.scale,y:(this.mouse.y+this.transform.view.y)/this.transform.scale},this.transform)})),this.addEventListener("mousemove",(t=>{this.hovered=!0,this.cursor.style.setProperty("--x",`${t.clientX.toString()}px`),this.cursor.style.setProperty("--y",`${t.clientY.toString()}px`);const e=this.canvas.getBoundingClientRect(),i={x:t.clientX-e.left,y:t.clientY-e.top},s=d(i,this.mouse);this.mouse=i,this.dragging?this.setView(d(this.transform.view,s)):this.data.mousemove({x:(this.mouse.x+this.transform.view.x)/this.transform.scale,y:(this.mouse.y+this.transform.view.y)/this.transform.scale},this.transform)})),this.addEventListener("mousedown",(t=>{t.stopImmediatePropagation(),this.data.mousedown(t)||(this.dragging=!0)})),this.addEventListener("mouseup",(t=>{t.stopImmediatePropagation(),this.dragging=!1,this.data.mouseup(t)})),this.addEventListener("mouseenter",(()=>{this.hovered=!0,this.cursor.classList.remove("hide")})),this.addEventListener("mouseleave",(()=>{this.hovered=!1,this.dragging=!1,this.cursor.classList.add("hide"),this.data.mouseleave()})),this.addEventListener("contextmenu",(t=>{t.preventDefault()}),!1),document.body.addEventListener("keydown",(t=>{if(this.hovered)switch(t.key){case"ArrowUp":this.holding_keys.arrow_up=!0;break;case"ArrowDown":this.holding_keys.arrow_down=!0;break;case"ArrowLeft":this.holding_keys.arrow_left=!0;break;case"ArrowRight":this.holding_keys.arrow_right=!0}})),document.body.addEventListener("keyup",(t=>{if(this.hovered)switch(t.key){case"ArrowUp":this.holding_keys.arrow_up=!1;break;case"ArrowDown":this.holding_keys.arrow_down=!1;break;case"ArrowLeft":this.holding_keys.arrow_left=!1;break;case"ArrowRight":this.holding_keys.arrow_right=!1}}))}tick(){const t={x:0,y:0},e=20*this.transform.scale;let i=!1;const s=this.canvas.getBoundingClientRect();if(this.holding_keys.arrow_up&&(t.y-=e,i=!0),this.holding_keys.arrow_down&&(t.y+=e,i=!0),this.holding_keys.arrow_left&&(t.x-=e,i=!0),this.holding_keys.arrow_right&&(t.x+=e,i=!0),!this.dragging&&this.data.allow_side_move){const r=!this.cursor_in_range&&!i;this.mouse.y<this.cursor_move_threshold&&(t.y-=e,i=!0),this.mouse.y>s.height-this.cursor_move_threshold&&(t.y+=e,i=!0),this.mouse.x<this.cursor_move_threshold&&(t.x-=e,i=!0),this.mouse.x>s.width-this.cursor_move_threshold&&(t.x+=e,i=!0),r&&(i?i=!1:this.cursor_in_range=!0)}i&&(this.setView({x:this.transform.view.x+t.x,y:this.transform.view.y+t.y}),this.data.mousemove({x:(this.mouse.x+this.transform.view.x)/this.transform.scale,y:(this.mouse.y+this.transform.view.y)/this.transform.scale},this.transform))}scaleView(t){this.setView({x:this.transform.view.x*t,y:this.transform.view.y*t})}setView(t){isNaN(t.x)||isNaN(t.y)||(t.x<0?t.x=0:t.x>this.data.board_size.x*this.transform.scale&&(t.x=this.data.board_size.x*this.transform.scale),t.y<0?t.y=0:t.y>this.data.board_size.y*this.transform.scale&&(t.y=this.data.board_size.y*this.transform.scale),this.transform.view=t)}getMaxScale(){return this.data.max_scale}setMaxScale(t){if(!t||t<1)return;const e=t/this.data.max_scale;this.data.max_scale=t,e?this.transform.scale>1?this.setScale(this.transform.scale*e):this.transform.scale<1&&this.setScale(this.transform.scale/e):this.setScale(this.transform.scale)}setScale(t){return t?(t<1/this.data.max_scale?t=1/this.data.max_scale:t>this.data.max_scale&&(t=this.data.max_scale),this.transform.view.x*=t/this.transform.scale,this.transform.view.y*=t/this.transform.scale,this.transform.scale=t,t):this.transform.scale}}customElements.define("dwg-canvas-board",vt);var xt=i(161),ft=i(7091),pt=i.n(ft),mt=new URL(i(6299),i.b);const wt='<div id="wrapper"> <canvas id="canvas"></canvas> <button id="close-button" class="set-size"> <img id="close-button-img" class="max-size" src="'+pt()(mt)+'" draggable="false"> </button> </div> ';var bt=i(2506),kt={};kt.styleTagTransform=lt(),kt.setAttributes=nt(),kt.insert=rt().bind(null,"head"),kt.domAPI=it(),kt.insertStyleElement=ht(),tt()(bt.Z,kt),bt.Z&&bt.Z.locals&&bt.Z.locals;class It extends xt.a{constructor(){super(),this.draw_interval=void 0,this.mouse={x:0,y:0},this.hovered_zone=void 0,this.hovered_space=void 0,this.hovered=!1,this.icons=new Map,this.configureElement("wrapper"),this.configureElement("canvas"),this.configureElement("close_button");for(const t of["unit","building","unit_white","building_white"])this.createIcon(t)}createIcon(t){const e=document.createElement("img");e.src=`/images/icons/${t}64.png`,e.draggable=!1,e.alt=t,this.icons.set(t,e)}getHTML(){return wt}closeDialog(){this.draw_interval&&clearInterval(this.draw_interval),document.body.removeEventListener("keyup",this.keyup.bind(this)),super.closeDialog()}getData(){return this.data}setData(t,e){if(t&&(this.data=t),!e&&!this.fully_parsed)return;if(!this.canvas.getContext)return void console.error("Browser does not support canvas; cannot draw board");for(const t of this.data.space.zones)for(const e of t)e.hovered=!1,e.clicked=!1;const i=.9;.7794*window.innerWidth>i*window.innerHeight?this.size={x:i*window.innerHeight/.866,y:i*window.innerHeight}:this.size={x:i*window.innerWidth,y:i*window.innerWidth*.866},this.radius=.37*this.size.x,this.ctx=this.canvas.getContext("2d"),this.canvas.style.setProperty("--w",`${this.size.x.toString()}px`),this.canvas.style.setProperty("--h",`${this.size.y.toString()}px`),this.canvas.width=this.size.x,this.canvas.height=this.size.y,this.wrapper.addEventListener("mousemove",(t=>{this.hovered=!0;const e=this.canvas.getBoundingClientRect();this.mousemove({x:t.clientX-e.left,y:t.clientY-e.top})})),this.wrapper.addEventListener("mousedown",(t=>{t.stopImmediatePropagation(),this.mousedown(t)})),this.wrapper.addEventListener("mouseup",(t=>{t.stopImmediatePropagation(),this.mouseup(t)})),this.wrapper.addEventListener("mouseenter",(()=>{this.hovered=!0})),this.wrapper.addEventListener("mouseleave",(()=>{this.hovered=!1,this.hovered_zone&&(this.unhoverZone(this.hovered_zone),this.hovered_zone=void 0),this.hovered_space&&(this.hovered_space.hovered=!1,this.hovered_space.clicked=!1,this.hovered_space=void 0)})),this.addEventListener("contextmenu",(t=>{t.preventDefault()}),!1),document.body.addEventListener("keyup",this.keyup.bind(this)),this.close_button.addEventListener("click",(()=>{this.closeDialog()})),this.draw_interval=setInterval((()=>{this.ctx.resetTransform(),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.size.x,this.size.y),this.draw()}),20)}draw(){var t,e;this.ctx.strokeStyle="rgba(250, 250, 250, 0.9)",this.ctx.fillStyle="rgb(0, 0, 0, 0)",this.ctx.lineWidth=4;const i=_(.5,this.size);this.ctx.translate(i.x,i.y);const s=this.radius,o=.42*s;r(this.ctx,{x:0,y:0},s),this.ctx.fillStyle="rgb(10, 120, 10, 0.8)",this.ctx.lineWidth=2;let n=this.data.space.zones[1][1];this.setZoneFill(n),r(this.ctx,{x:0,y:0},.4*s),this.drawZone(n,o,0,{x:.18*s*Math.cos(1*Math.PI/4),y:.18*s*Math.sin(1*Math.PI/4)},{x:.18*s*Math.cos(3*Math.PI/4),y:.18*s*Math.sin(3*Math.PI/4)},{x:.18*s*Math.cos(5*Math.PI/4),y:.18*s*Math.sin(5*Math.PI/4)},{x:.18*s*Math.cos(7*Math.PI/4),y:.18*s*Math.sin(7*Math.PI/4)}),this.ctx.lineWidth=4;const a=Math.PI/3;for(var h=0;h<6;h++){let i={x:0,y:0};switch(h){case 0:i={x:2,y:1};break;case 1:i={x:2,y:0};break;case 2:i={x:1,y:0};break;case 3:i={x:0,y:0};break;case 4:i={x:0,y:1};break;case 5:i={x:1,y:2}}n=this.data.space.zones[i.x][i.y],this.setZoneFill(n),this.ctx.beginPath(),this.ctx.lineTo(.4*s*Math.cos(a*h+Math.PI/6),.4*s*Math.sin(a*h+Math.PI/6)),this.ctx.lineTo(.4*s*Math.cos(a*h+Math.PI/2),.4*s*Math.sin(a*h+Math.PI/2)),this.ctx.lineTo(s*Math.cos(a*h+Math.PI/2),s*Math.sin(a*h+Math.PI/2)),this.ctx.lineTo(s*Math.cos(a*h+Math.PI/6),s*Math.sin(a*h+Math.PI/6)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill();const r=a*(1+h);this.ctx.rotate(r);const c=Math.PI/15;this.drawZone(n,o,r,{x:.76*s*Math.cos(-c),y:.76*s*Math.sin(-c)},{x:.76*s*Math.cos(c),y:.76*s*Math.sin(c)},{x:.53*s*Math.cos(-c),y:.53*s*Math.sin(-c)},{x:.53*s*Math.cos(c),y:.53*s*Math.sin(c)}),this.ctx.rotate(-r),this.ctx.lineWidth=4;const d=C(1,i),_=N(this.data.game.getGame().board_size,l(this.data.space.coordinate,d)),u=T(this.data.game.getGame(),_);this.ctx.strokeStyle="rgba(250, 250, 250, 0.8)";const g=Y(u).dAlpha(-.2);if(this.ctx.fillStyle=g.getString(),this.ctx.beginPath(),this.ctx.lineTo(s*Math.cos(a*h+Math.PI/6),s*Math.sin(a*h+Math.PI/6)),this.ctx.lineTo(3*s*Math.cos(a*h+Math.PI/6),3*s*Math.sin(a*h+Math.PI/6)),this.ctx.lineTo(3*s*Math.cos(a*h+Math.PI/2),3*s*Math.sin(a*h+Math.PI/2)),this.ctx.lineTo(s*Math.cos(a*h+Math.PI/2),s*Math.sin(a*h+Math.PI/2)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill(),u&&u.visibility>0){let i=this.icons.get("building"),r=this.icons.get("unit");g.getBrightness()>.5?this.ctx.fillStyle="black":(this.ctx.fillStyle="white",i=this.icons.get("building_white"),r=this.icons.get("unit_white")),this.ctx.textBaseline="top";const o=.27*s,n=.866*o,c=(.866*s+n)*Math.cos(a*h+Math.PI/3),l=(.866*s+n)*Math.sin(a*h+Math.PI/3),d=.25,_=2*n*(1-d),y=o*(1+d),v=y/3-4;this.ctx.font=`bold ${v}px serif`;const x=c-.5*_,f=l-.5*y;this.ctx.drawImage(i,x,f,v,v),this.ctx.fillText(`: ${null===(t=u.buildings)||void 0===t?void 0:t.size.toString()}`,x+v+2,f,_-v-2);const p=l-.5*y+v+2;this.ctx.drawImage(r,x,p,v,v),this.ctx.fillText(`: ${null===(e=u.units)||void 0===e?void 0:e.size.toString()}`,x+v+2,p,_-v-2)}}}mousemove(t){var e,i;let s,r;if(this.mouse=d({x:t.x,y:t.y},_(.5,this.size)),v(this.mouse,.4*this.radius))s=this.data.space.zones[1][1],this.resolveHoveredZone(s,0);else{const t=(0,b.fd)(this.mouse.y,this.mouse.x);let e=Math.floor((t+Math.PI/6)/(Math.PI/3)),i={x:0,y:0};switch(e){case 6:e=0;case 0:i={x:1,y:2};break;case 1:i={x:0,y:1};break;case 2:i={x:0,y:0};break;case 3:i={x:1,y:0};break;case 4:i={x:2,y:0};break;case 5:i={x:2,y:1};break;default:return void console.error("Unknown zone hovered",t)}if(v(this.mouse,this.radius))s=this.data.space.zones[i.x][i.y],this.resolveHoveredZone(s,-Math.PI/3*(6-e));else{const t=C(1,i),e=N(this.data.game.getGame().board_size,l(this.data.space.coordinate,t));r=T(this.data.game.getGame(),e)}}c(null===(e=this.hovered_space)||void 0===e?void 0:e.coordinate,null==r?void 0:r.coordinate)||(this.hovered_space&&(this.hovered_space.clicked=!1,this.hovered_space.hovered=!1),this.hovered_space=r,this.hovered_space&&(this.hovered_space.hovered=!0)),this.hovered_zone&&!c(null===(i=this.hovered_zone)||void 0===i?void 0:i.coordinate,null==s?void 0:s.coordinate)&&(this.unhoverZone(this.hovered_zone),this.hovered_zone=void 0),this.hovered_zone=s}unhoverZone(t){t.clicked=!1,t.hovered=!1;for(const e of t.hovered_data)e.clicked=!1,e.hovered=!1}resolveHoveredZone(t,e){t.hovered=!0;const i=u(this.mouse,e);for(const e of t.hovered_data){const t=i.x-e.c.x,s=i.y-e.c.y;t*t/(e.r.x*e.r.x)+s*s/(e.r.y*e.r.y)<=1?e.hovered=!0:e.hovered=!1}}mousedown(t){if(this.hovered_zone){this.hovered_zone.clicked=!0;for(const t of this.hovered_zone.hovered_data)t.hovered&&(t.clicked=!0)}}mouseup(t){if(this.hovered_zone){this.hovered_zone.clicked=!1;for(const t of this.hovered_zone.hovered_data)t.clicked=!1}}keyup(t){"Escape"===t.key&&this.closeDialog()}setZoneFill(t){this.ctx.strokeStyle="rgba(250, 250, 250, 0.9)";const e=new k(10,120,10,.8);t.hovered&&!t.hovered_data.some((t=>t.hovered))&&(t.clicked?e.addColor(210,210,210,.05):e.addColor(190,190,190,.03)),this.ctx.fillStyle=e.getString()}drawZone(t,e,i,s,r,n,a){function h(t,e,i,s,r,o,n="white"){const a=t.fillStyle;t.fillStyle=n,t.font=`bold ${i}px serif`,t.fillText(e,s,r,o),t.fillStyle=a}this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.lineWidth=1;const c=.5*e;if(4!==t.hovered_data.length){const e={x:.5*c,y:.5*c};t.hovered_data=[{c:s,r:e},{c:r,r:e},{c:n,r:e},{c:a,r:e}]}else t.hovered_data[0].c=s,t.hovered_data[1].c=r,t.hovered_data[2].c=n,t.hovered_data[3].c=a;for(const[e,s]of t.hovered_data.entries()){switch(this.ctx.strokeStyle="transparent",s.hovered?s.clicked?this.ctx.fillStyle="rgba(200, 200, 200, 0.4)":this.ctx.fillStyle="rgba(200, 200, 200, 0.2)":this.ctx.fillStyle="transparent",this.ctx.translate(s.c.x,s.c.y),this.ctx.rotate(-i),e){case 0:t.building?this.ctx.drawImage(this.data.game.getIcon($(t.building)),-s.r.x,-s.r.y,2*s.r.x,2*s.r.y):this.ctx.strokeStyle="rgba(200, 200, 200, 0.5)";break;case 1:if(t.units_by_type||G(t),0===t.units_by_type.size)this.ctx.strokeStyle="rgba(200, 200, 200, 0.5)",h(this.ctx,"0",1.4*s.r.y,-.5*s.r.x,-.7*s.r.y,s.r.x);else if(1===t.units_by_type.size){const e=[...t.units_by_type.values()][0],i=t.units.get([...e.units.values()][0]);this.ctx.drawImage(Z(i),-s.r.x,-s.r.y,2*s.r.x,2*s.r.y),h(this.ctx,e.units.size.toString(),1.4*s.r.y,-s.r.x,-.7*s.r.y,2*s.r.x)}else if(2===t.units_by_type.size){const e=[...t.units_by_type.values()];for(let i=0;i<2;i++){const r=[...e[i].units.values()],o=t.units.get(r[0]);this.ctx.drawImage(Z(o),(.5*i-1)*s.r.x,(.5*i-1)*s.r.y,1.5*s.r.x,1.5*s.r.y),h(this.ctx,r.length.toString(),s.r.y,(.5*i-1)*s.r.x,(.5*i-1)*s.r.y,2*s.r.x)}}else if(3===t.units_by_type.size){const e=[...t.units_by_type.values()];for(let i=0;i<2;i++){const r=[...e[i].units.values()],o=t.units.get(r[0]);this.ctx.drawImage(Z(o),(.8*i-.9)*s.r.x,-.9*s.r.y,s.r.x,s.r.y),h(this.ctx,r.length.toString(),.75*s.r.y,(.8*i-1)*s.r.x,-.9*s.r.y,1.5*s.r.x)}const i=[...e[2].units.values()],r=t.units.get(i[0]);this.ctx.drawImage(Z(r),-.5*s.r.x,-.1*s.r.y,s.r.x,s.r.y),h(this.ctx,i.length.toString(),.75*s.r.y,-.5*s.r.x,-.1*s.r.y,1.5*s.r.x)}else if(4===t.units_by_type.size){const e=[...t.units_by_type.values()];for(let i=0;i<2;i++){const r=[...e[i].units.values()],o=t.units.get(r[0]);this.ctx.drawImage(Z(o),(.8*i-.9)*s.r.x,-.9*s.r.y,s.r.x,s.r.y),h(this.ctx,r.length.toString(),.75*s.r.y,(.8*i-.9)*s.r.x,-.9*s.r.y,1.5*s.r.x)}for(let i=0;i<2;i++){const r=[...e[2+i].units.values()],o=t.units.get(r[0]);this.ctx.drawImage(Z(o),(.8*i-.9)*s.r.x,-.1*s.r.y,s.r.x,s.r.y),h(this.ctx,r.length.toString(),.75*s.r.y,(.8*i-.9)*s.r.x,-.1*s.r.y,1.5*s.r.x)}}else{const e=[...t.units_by_type.values()];for(let i=0;i<2;i++){const r=[...e[i].units.values()],o=t.units.get(r[0]);this.ctx.drawImage(Z(o),(.8*i-.9)*s.r.x,-.9*s.r.y,s.r.x,s.r.y)}for(let i=0;i<1;i++){const r=[...e[2+i].units.values()],o=t.units.get(r[0]);this.ctx.drawImage(Z(o),(.8*i-.9)*s.r.x,-.1*s.r.y,s.r.x,s.r.y)}h(this.ctx,"...",.8*s.r.y,.1*s.r.x,-.1*s.r.y,s.r.x,"rgba(150, 150, 150, 0.8)"),h(this.ctx,t.units.size.toString(),1.4*s.r.y,-s.r.x,-.7*s.r.y,2*s.r.x)}break;case 2:case 3:this.ctx.strokeStyle="rgba(200, 200, 200, 0.2)",this.ctx.fillStyle="transparent";break;default:console.error("No implemented")}this.ctx.rotate(i),this.ctx.translate(-s.c.x,-s.c.y),o(this.ctx,s.c,s.r)}}}customElements.define("dwg-space-dialog",It);var Mt=function(t,e,i,s){return new(i||(i=Promise))((function(r,o){function n(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,a)}h((s=s.apply(t,e||[])).next())}))};class zt extends s.r{constructor(){super(),this.hex_r=60,this.hex_a=51.96,this.canvas_center={x:0,y:0},this.last_transform={view:{x:0,y:0},scale:1},this.canvas_size=DOMRect.fromRect(),this.mouse_canvas={x:0,y:0},this.mouse_coordinate={x:0,y:0},this.icons=new Map,this.last_time=Date.now(),this.draw_detail=m.SPACE_DETAILS,this.left_panel=new J(this,{w:300,background:"rgb(222,184,135)"}),this.right_panel=new B(this,{w:300,is_open:!0,background:"rgb(222,184,135)"}),this.board_resize_lock=(0,w.YH)(),this.htmlString=' <dwg-canvas-board id="board"></dwg-canvas-board> ',this.configureElement("board")}createIcon(t){if(this.icons.has(t))return;const e=document.createElement("img");e.src=`/images/${t}.png`,e.draggable=!1,e.alt=t,this.icons.set(t,e)}getIcon(t){return this.icons.has(t)||this.createIcon(t),this.icons.get(t)}initialize(t,e){return Mt(this,void 0,void 0,(function*(){this.player_id=t.is_player?t.player_id:-1,t.setPadding("0px"),this.game=I(e);const i={x:1.732*this.hex_r*(2*e.board_size+1),y:1.5*this.hex_r*(2*e.board_size+1)+.5*this.hex_r};this.board.initialize({board_size:i,max_scale:1,fill_space:!0,allow_side_move:!1,draw:this.draw.bind(this),mousemove:this.mousemove.bind(this),mouseleave:this.mouseleave.bind(this),mousedown:this.mousedown.bind(this),mouseup:this.mouseup.bind(this)}).then((e=>{this.boardResize(e.board_size,e.el_size),t.is_player?this.goToVillageCenter(this.player_id):this.goToVillageCenter(0),this.board.addEventListener("canvas_resize",(t=>{this.boardResize(t.detail.board_size,t.detail.el_size)}))}))}))}getGame(){return this.game}getPlayer(){return this.player_id>-1?this.game.players[this.player_id]:void 0}goToVillageCenter(t){var e;if(!(t<0))for(const i of this.game.players[t].buildings.values()){if(1!==i.building_id)continue;const t=this.coordinateToCanvas(i.space_coordinate,null!==(e=this.last_transform.scale)&&void 0!==e?e:1);return void this.board.setView(d(t,this.canvas_center))}}boardResize(t,e){this.board_resize_lock((()=>Mt(this,void 0,void 0,(function*(){var i,s,r;const o=.5*Math.min(t.x,e.width)/this.canvas_center.x;this.canvas_center={x:.5*Math.min(t.x,e.width),y:.5*Math.min(t.y,e.height)},this.canvas_size=e,this.hex_r=t.x/(1.732*(2*this.game.board_size+1)),this.hex_a=.866*this.hex_r,this.board.setMaxScale(.45*e.height/this.hex_r),this.board.scaleView(o);for(const t of null!==(s=null===(i=this.game)||void 0===i?void 0:i.spaces)&&void 0!==s?s:[])for(const e of t)for(const t of null!==(r=e.zones)&&void 0!==r?r:[])for(const e of t)e.reset_hovered_data=!0;this.left_panel.resolveSize(),this.toggleRightPanel(this.right_panel.isOpen())}))))}canvasSize(){return this.canvas_size}toggleRightPanel(t){this.right_panel.toggle(t)}closeLeftPanel(){this.left_panel.close()}gameUpdate(t){return Mt(this,void 0,void 0,(function*(){try{if("start-turn"===t.kind){const e=t.update;yield this.applyStartTurn(e)}else console.log(`Unknown game update type ${t.kind}`)}catch(e){console.log(`Error during game update ${JSON.stringify(t)}: ${e}`)}}))}applyStartTurn(t){return Mt(this,void 0,void 0,(function*(){this.game=I(t.game)}))}draw(t,e){const i=Date.now(),s=i-this.last_time;this.last_time=i,this.last_transform=e;const r=2*this.hex_a*.75,o=1.25*this.hex_r,n=o/3-4;this.draw_detail=this.getDrawDetail(e.scale);const a={hex_r:this.hex_r,inset_w:r,inset_h:o,inset_row:n,draw_detail:this.draw_detail};t.font=`bold ${n}px serif`;for(const i of this.game.spaces)for(const s of i)s.center=this.coordinateToCanvas(s.coordinate,e.scale),s.center.x+this.hex_a<e.view.x/e.scale||s.center.x-this.hex_a>(e.view.x+this.canvas_size.width)/e.scale||s.center.y+this.hex_r<e.view.y/e.scale||s.center.y-this.hex_r>(e.view.y+this.canvas_size.height)/e.scale||K(t,this,s,a);this.right_panel.draw(t,e,s),this.left_panel.draw(t,e,s)}getDrawDetail(t){const e=this.board.getMaxScale();return t>.6*(e-1)+1?m.ZONE_DETAILS:t<1/(.2*(e-1)+1)?m.OWNERSHIP:m.SPACE_DETAILS}mousemove(t,e){var i;this.mouse_canvas=t;const s=[this.right_panel.mousemove(t,e),this.left_panel.mousemove(t,e)].some((t=>!!t));this.mouse_coordinate=this.canvasToCoordinate(t,e.scale);const r=N(this.game.board_size,g(this.mouse_coordinate)),o=T(this.game,r);if(s||!o)return this.removeHoveredFlags(),void(this.hovered_space&&(this.hovered_space.clicked=!1,this.hovered_space=void 0,this.hovered_zone&&(V(this.hovered_zone),this.hovered_zone=void 0)));const n=()=>{var e;if(this.draw_detail===m.ZONE_DETAILS){let i=function(t,e,i){if(!e.zones)return;const s=(t,e,i)=>{e.hovered=!0;const s=u(t,i);for(const t of e.hovered_data){const e=s.x-t.c.x,i=s.y-t.c.y;e*e/(t.r.x*t.r.x)+i*i/(t.r.y*t.r.y)<=1?t.hovered=!0:t.hovered=!1}},r=d({x:t.x,y:t.y},e.center);let o;if(v(r,.4*i))o=e.zones[1][1],s(r,o,0);else{const t=(0,b.fd)(r.y,r.x);let i=Math.floor((t+Math.PI/6)/(Math.PI/3)),n={x:0,y:0};switch(i){case 6:i=0;case 0:n={x:1,y:2};break;case 1:n={x:0,y:1};break;case 2:n={x:0,y:0};break;case 3:n={x:1,y:0};break;case 4:n={x:2,y:0};break;case 5:n={x:2,y:1};break;default:return void console.error("Unknown zone hovered",t)}o=e.zones[n.x][n.y],s(r,o,-Math.PI/3*(6-i))}return o}(t,this.hovered_space,this.hex_r);this.hovered_zone&&!c(null==i?void 0:i.coordinate,null===(e=this.hovered_zone)||void 0===e?void 0:e.coordinate)&&(V(this.hovered_zone),this.hovered_zone=void 0),this.hovered_zone=i}else this.hovered_zone&&(V(this.hovered_zone),this.hovered_zone=void 0)};if(c(o.coordinate,null===(i=this.hovered_space)||void 0===i?void 0:i.coordinate))return this.updateHoveredFlags(),void n.call(this);this.removeHoveredFlags(),this.hovered_space&&(this.hovered_space.clicked=!1,this.hovered_zone&&(V(this.hovered_zone),this.hovered_zone=void 0),n.call(this)),this.hovered_space=o,this.updateHoveredFlags()}mouseleave(){this.hovered_space&&(this.hovered_space.hovered=!1,this.hovered_space.clicked=!1,this.hovered_space=void 0)}mousedown(t){if([this.right_panel.mousedown(t),this.left_panel.mousedown(t)].some((t=>!!t)))return!0;if(0!==t.button)return!1;if(this.hovered_space&&this.hovered_space.visibility>0){if(this.hovered_space.clicked=!0,this.draw_detail!==m.ZONE_DETAILS)return!0;if(this.hovered_zone){this.hovered_space.clicked=!1,this.hovered_zone.clicked=!0;for(const t of this.hovered_zone.hovered_data)if(t.hovered)return t.clicked=!0,!0}}return!1}mouseup(t){if(this.right_panel.mouseup(t),this.left_panel.mouseup(t),this.hovered_space){if(this.hovered_zone){if(this.hovered_zone.clicked&&this.hovered_space.visibility>0&&this.draw_detail===m.ZONE_DETAILS)for(const[t,e]of this.hovered_zone.hovered_data.entries())e.clicked&&0===t&&(this.hovered_zone.resource?this.left_panel.openPanel(X.RESOURCE,this.hovered_space.visibility,this.hovered_zone.resource):this.left_panel.openPanel(X.BUILDING,this.hovered_space.visibility,this.hovered_zone.building));this.hovered_zone.clicked=!1;for(const t of this.hovered_zone.hovered_data)t.clicked=!1}else this.hovered_space.clicked&&this.hovered_space.visibility>0&&(this.draw_detail,m.ZONE_DETAILS);this.hovered_space.clicked=!1}}canvasToCoordinate(t,e){const i=(t.y-.25*this.hex_r-this.canvas_center.y/e)/(1.5*this.hex_r)-this.game.board_size-.5;return{x:(t.x-this.canvas_center.x/e)/(1.732*this.hex_r)-.5*i-this.game.board_size-.5,y:i}}coordinateToCanvas(t,e){return{x:1.732*(t.x+.5*t.y+this.game.board_size+.5)*this.hex_r+this.canvas_center.x/e,y:1.5*(t.y+this.game.board_size+.5)*this.hex_r+.25*this.hex_r+this.canvas_center.y/e}}removeHoveredFlags(){if(this.hovered_space){this.hovered_space.hovered=!1;for(const t of this.getBoardNeighbors(this.hovered_space))t.hovered_neighbor=!1;for(const t of this.getBoardRows(this.hovered_space))t.hovered_row=!1}}updateHoveredFlags(){if(this.hovered_space){this.hovered_space.hovered=!0;for(const t of this.getBoardNeighbors(this.hovered_space))t.hovered_neighbor=!0;for(const t of this.getBoardRows(this.hovered_space))t.hovered_row=!0}}getBoardNeighbors(t){const e=[];for(const i of function(t,e){const i=g(t),s=[];for(const t of y){const r=l(i,t);x(r,e)&&s.push(r)}return s}(t.coordinate,this.game.board_size)){const t=N(this.game.board_size,i),s=T(this.game,t);s&&e.push(s)}return e}getBoardRows(t){const e=[];for(const i of function(t,e){const i=g(t),s=[];for(const t of y){let r=i;for(;r=l(r,t),x(r,e);)s.push(r)}return s}(t.coordinate,this.game.board_size)){const t=N(this.game.board_size,i),s=T(this.game,t);s&&e.push(s)}return e}}customElements.define("dwg-risq",zt)},6442:(t,e,i)=>{function s(t,e){return(t%e+e)%e}function r(t,e){const i=Math.atan2(t,e);return 0===i?0:i<0?-i:2*Math.PI-i}function o(t,e,i,s=!0){return isNaN(e)||null==e||isNaN(i)||null==i?t:i<e?o(t,i,e):isNaN(t)||null==t?s?e:i:t>i?i:t<e?e:t}i.d(e,{IV:()=>o,fd:()=>r,zW:()=>s})}},t=>{t(t.s=4431)}]);